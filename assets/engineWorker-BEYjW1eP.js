(function(){"use strict";const U={wP:0,wN:1,wB:2,wR:3,wQ:4,wK:5,bP:6,bN:7,bB:8,bR:9,bQ:10,bK:11},G=12,H=0,$=1,V=2,_=3,O=4,T=5,Y=6,o0=7,Z=8,M=9,R=10,C=11,K=new BigUint64Array(G);K[U.wP]=BigInt("0x000000000000FF00"),K[U.wN]=BigInt("0x0000000000000042"),K[U.wB]=BigInt("0x0000000000000024"),K[U.wR]=BigInt("0x0000000000000081"),K[U.wQ]=BigInt("0x0000000000000008"),K[U.wK]=BigInt("0x0000000000000010"),K[U.bP]=BigInt("0x00FF000000000000"),K[U.bN]=BigInt("0x4200000000000000"),K[U.bB]=BigInt("0x2400000000000000"),K[U.bR]=BigInt("0x8100000000000000"),K[U.bQ]=BigInt("0x0800000000000000"),K[U.bK]=BigInt("0x1000000000000000");const u0=0x7f7f7f7f7f7f7f7fn,a0=0xfefefefefefefefen,E0=0x00ffffffffffffffn,k0=0xffffffffffffff00n,Hn={0:"P",1:"N",2:"B",3:"R",4:"Q",5:"K",6:"p",7:"n",8:"b",9:"r",10:"q",11:"k"},On={0:"a",1:"b",2:"c",3:"d",4:"e",5:"f",6:"g",7:"h"},Rn=[0xabc123n,0xdef456n,0x789abcn,0x123defn],_0=0,M0=1,T0=2,C0=3,F0=1e5,dn=32,Un=[O,_,V,$],Qn=[R,M,Z,o0],Fn=[{df:1,dr:0},{df:-1,dr:0},{df:0,dr:1},{df:0,dr:-1},{df:1,dr:1},{df:-1,dr:1},{df:1,dr:-1},{df:-1,dr:-1}],v0=n=>n>=0&&n<64,vn=0x03f79d71b4cb0a89n,yn=[0,1,48,2,57,49,28,3,61,58,50,42,38,29,17,4,62,55,59,36,53,51,43,22,45,39,33,30,24,18,12,5,63,47,56,27,60,41,37,16,54,35,52,21,44,32,23,11,46,26,40,15,34,20,31,10,25,14,19,9,13,8,7,6],j=n=>{if(n===0n)return-1;const t=n&-n,e=BigInt.asUintN(64,t*vn),s=Number(e>>58n);return yn[s]},y0=n=>{let t=0;for(;n;)n&=n-1n,t++;return t},I0=n=>n===T||n===C,G0=n=>!(n%6===H||n%6===$||I0(n));function z0(n){let t=0;for(;n!==0n;)n&=n-1n,t++;return t}const i0=n=>n[H]|n[$]|n[V]|n[_]|n[O]|n[T],l0=n=>n[Y]|n[o0]|n[Z]|n[M]|n[R]|n[C],Q=n=>BigInt(i0(n)|l0(n)),J=(n,t)=>n===0?i0(t):l0(t),Gn=n=>~(i0(n)|l0(n)),g=new Array(64).fill(null);function D0(n){zn();for(let t=0;t<G;t++){let e=n[t];for(;e;){const s=j(e);g[s]=t,e&=e-1n}}}function zn(){for(let n=0;n<64;n++)g[n]=null}D0(K);function Dn(n,t){return t===0?n[_]|n[O]:n[M]|n[R]}function $n(n,t){return t===0?n[V]|n[O]:n[Z]|n[R]}const w=Array.from({length:G},()=>[]);Y0(K);function $0(n){const{piece:t,from:e,to:s,captured:o,promotion:c,enPassant:r,castling:l}=n,i=w[t];if(c!==null?(w[c].push(s),i.splice(i.indexOf(e),1)):i[i.indexOf(e)]=s,o!==null){const f=w[o];if(r){const k=s>e?s-8:s+8;f.splice(f.indexOf(k),1)}else f.splice(f.indexOf(s),1)}if(l)if(e===4){const f=w[_];s===6?f[f.indexOf(7)]=5:f[f.indexOf(0)]=3}else{const f=w[M];s===62?f[f.indexOf(63)]=61:f[f.indexOf(56)]=59}}function q0(n){const{piece:t,from:e,to:s,captured:o,promotion:c,enPassant:r,castling:l}=n,i=w[t];if(c){const f=w[c];f.splice(f.indexOf(s),1),i.push(e)}else i[i.indexOf(s)]=e;if(o!==null){const f=w[o];if(r){const k=s>e?s-8:s+8;f.push(k)}else f.push(s)}if(l)if(e===4){const f=w[_];s===6?f[f.indexOf(5)]=7:f[f.indexOf(3)]=0}else{const f=w[M];s===62?f[f.indexOf(61)]=63:f[f.indexOf(59)]=56}}function X0(n){const t=n===0?0:6,e=[];for(let s=t;s<t+6;s++)e.push(...w[s]);return e}function V0(){let n=[];for(let t=0;t<G;t++)n.push(...w[t]);return n}function Y0(n){for(let t=0;t<G;t++)w[t].length=0;for(let t=0;t<G;t++){let e=n[t];const s=w[t];for(;e;){const o=j(e);s.push(o),e&=e-1n}}}function Z0(n,t,e,s){const o=[];for(let B=7;B>=0;B--){let E="",a=0;for(let u=0;u<8;u++){const I=B*8+u,h=g[I];h===null?a+=1:(a&&(E+=a,a=0),E+=Hn[h])}a&&(E+=a),o.push(E)}const c=o.join("/"),r=t===0?"w":"b",l="-",i=s!==null?qn(s):"-";return`${c} ${r} ${l} ${i} 0 1`}function qn(n){const t=Math.floor(n/8)+1,e=n%8;return""+On[e]+t}function j0(n){let t="";for(let e=7;e>=0;e--){let s="";for(let o=0;o<8;o++){let c=BigInt(1)<<BigInt(e*8+o);s+=n&c?"1 ":"0 "}t+=s.trim()+`
`}return t}const g0=(n,t)=>{const e=t.piece,s=t.captured,o=t.promotion,c=Q(n);G0(e)||(z[e]=c0(e,c)),s!==null&&!G0(s)&&(z[s]=c0(s,c)),(o===$||o===o0)&&(z[o]=c0(o,c));const r=[V,_,O,Z,M,R],l=Vn(t);for(const i of r)Xn(i,t,c,l)};function Xn(n,t,e,s){if(t.captured===n||t.piece===n||t.promotion===n){z[n]=c0(n,e);return}(z[n]&s)!==0n&&(z[n]=c0(n,e))}function Vn(n){let t=0n;if(t|=1n<<BigInt(n.from),t|=1n<<BigInt(n.to),n.enPassant){const e=n.piece<6?-8:8,s=n.to+e;t|=1n<<BigInt(s)}return t}const f0=n=>{let t=0n;if(n===0)for(let e=0;e<6;e++)t|=z[e];else for(let e=6;e<=11;e++)t|=z[e];return t},J0=(n,t,e)=>{const s=[...e];return n===4?(s[_0]=!1,s[M0]=!1):n===60?(s[T0]=!1,s[C0]=!1):n===0||t===0?s[M0]=!1:n===7||t===7?s[_0]=!1:n===56||t===56?s[C0]=!1:(n===63||t===63)&&(s[T0]=!1),s},b0=(n,t,e)=>{let s;n===0?s=[4,5,6]:s=[60,61,62];for(const o of s){const c=1n<<BigInt(o);if(t&c||c&e&&(n===0?o!==4:o!==60))return!1}return!0},nn=(n,t,e)=>{let s;n===0?s=[1,2,3,4]:s=[57,58,59,60];for(const o of s){const c=1n<<BigInt(o);if(t&c&&o!==1&&o!==57||c&e&&(n===0?o!==4:o!==60))return!1}return!0},Yn=(n,t)=>{const e=t.from,s=t.to;Q(n),e===4&&s===6?(n[T]&=~(1n<<4n),n[T]|=1n<<6n,n[_]&=~(1n<<7n),n[_]|=1n<<5n,g[s]=T,g[e]=null,g[7]=null,g[5]=_):e===4&&s===2?(n[T]&=~(1n<<4n),n[T]|=1n<<2n,n[_]&=~(1n<<0n),n[_]|=1n<<3n,g[s]=T,g[e]=null,g[0]=null,g[3]=_):e===60&&s===62?(n[C]&=~(1n<<60n),n[C]|=1n<<62n,n[M]&=~(1n<<63n),n[M]|=1n<<61n,g[s]=C,g[e]=null,g[63]=null,g[61]=M):e===60&&s===58&&(n[C]&=~(1n<<60n),n[C]|=1n<<58n,n[M]&=~(1n<<56n),n[M]|=1n<<59n,g[s]=C,g[e]=null,g[56]=null,g[59]=M),$0(t),g0(n,t)},Zn=(n,t)=>{const e=t.from,s=t.to;Q(n),e===4&&s===6?(n[T]&=~(1n<<6n),n[T]|=1n<<4n,n[_]&=~(1n<<5n),n[_]|=1n<<7n,g[e]=T,g[s]=null,g[5]=null,g[7]=_):e===4&&s===2?(n[T]&=~(1n<<2n),n[T]|=1n<<4n,n[_]&=~(1n<<3n),n[_]|=1n<<0n,g[e]=T,g[s]=null,g[3]=null,g[0]=_):e===60&&s===62?(n[C]&=~(1n<<62n),n[C]|=1n<<60n,n[M]&=~(1n<<61n),n[M]|=1n<<63n,g[e]=C,g[s]=null,g[61]=null,g[63]=M):e===60&&s===58&&(n[C]&=~(1n<<58n),n[C]|=1n<<60n,n[M]&=~(1n<<59n),n[M]|=1n<<56n,g[e]=C,g[s]=null,g[59]=null,g[56]=M),q0(t),g0(n,t)};class w0{constructor(t,e,s,o,c,r,l){this.from=t,this.to=e,this.piece=s,this.captured=o,this.promotion=c,this.castling=r,this.enPassant=l}copyWith({from:t,to:e,piece:s,captured:o,promotion:c,castling:r,enPassant:l}){return new w0(t??this.from,e??this.to,s??this.piece,o??this.captured,c??this.promotion,r??this.castling,l??this.enPassant)}}const tn=(n,t)=>{const e=1n,s=e<<BigInt(t.from),o=e<<BigInt(t.to),c=t.piece,r=t.captured,l=t.promotion,i=t.enPassant;if(Q(n),t.castling){Yn(n,t);return}if(n[c]&=~s,t.captured!==null&&!i&&(n[r]&=~o),g[t.from]=null,l?(n[l]|=o,g[t.to]=l):(n[c]|=o,g[t.to]=c),i){const f=c===H?-8:8;n[r]&=~(e<<BigInt(t.to+f)),g[t.to+f]=null}$0(t),g0(n,t)},en=(n,t)=>{const e=n.from,s=n.to,o=1n,c=o<<BigInt(e),r=o<<BigInt(s),l=n.piece,i=n.captured,f=n.promotion,k=n.enPassant;if(n.castling){Zn(t,n);return}if(g[s]=null,g[e]=l,f?(t[f]&=~r,t[l]|=c):(t[l]&=~r,t[l]|=c),i!==null&&!k&&(t[i]|=r,g[s]=i),k){const E=s+(l===H?-8:8);t[i]|=o<<BigInt(E),g[E]=i}q0(n),g0(t,n)},jn=(n,t,e,s)=>{const o=e<=5,c=I0(e)&&Math.abs(n-t)===2,r=t===s&&(e===H||e===Y);let l=g[t];return r&&(l=o?Y:H),new w0(n,t,e,l,null,c,r)},sn=(n,t,e,s,o)=>{const c=[],r=o===0?6:1,i=Math.floor(t/8)===r&&e%6===H;let f=n;for(;f!==0n;){const k=j(f);f&=f-1n;const B=jn(t,k,e,s);if(i){const E=o===0?Un:Qn;for(const a of E){const u=B.copyWith({promotion:a});c.push(u)}}else c.push(B)}return c},Jn=n=>{const t=1n<<BigInt(n);let e=0n;return n%8!==0&&(e|=t<<7n),n%8!==7&&(e|=t<<9n),e},bn=n=>{const t=1n<<BigInt(n);let e=0n;return n%8!==0&&(e|=t>>9n),n%8!==7&&(e|=t>>7n),e},B0=(()=>{const n=new Array(64);for(let t=0;t<64;t++)n[t]=Jn(t);return n})(),x0=(()=>{const n=new Array(64);for(let t=0;t<64;t++)n[t]=bn(t);return n})(),nt=[17,15,10,6,-17,-15,-10,-6],tt=n=>{let t=0n;for(const e of nt){const s=n+e;v0(s)&&et(n,s)&&(t|=1n<<BigInt(s))}return t},et=(n,t)=>{const e=n%8,s=t%8,o=Math.abs(e-s);return!(o!==1&&o!==2)},m0=(()=>{const n=new Array(64);for(let t=0;t<64;t++)n[t]=tt(t);return n})();function on(n,t,e){const s=t===0,o=n[s?Y:H],c=(s?B0[e]:x0[e])&o,r=n[s?o0:$],l=m0[e]&r,i=st(n,e,Q(n),s);return c|l|i}function st(n,t,e,s){let o=0n,r=n0(t,e)&e;const l=s?n[M]|n[R]:n[_]|n[O];o|=r&l;let f=b(t,e)&e;const k=s?n[Z]|n[R]:n[V]|n[O];return o|=k&f,o}function cn(n,t){if(n===t)return 0n;const e=n%8,s=(n-e)/8,o=t%8,r=(t-o)/8-s,l=o-e,i=r===0?0:r/Math.abs(r),f=l===0?0:l/Math.abs(l),k=1n<<BigInt(n),B=1n<<BigInt(t),E=r>0?E0:k0,a=l>0?u0:a0,u=k|B;if(r===0)return y(k,BigInt(f),a,u)&~B;if(l===0)return y(k,BigInt(i*8),E,u)&~B;if(Math.abs(r)!==Math.abs(l))throw new Error(`No compass direction between ${n} & ${t}`);return y(k,BigInt(i*8+f),E&a,u)&~B}const rn=Array.from({length:64},()=>Array(64).fill(0n));for(let n=0;n<64;n++){const t=n%8,e=Math.floor(n/8);for(const{df:s,dr:o}of Fn){let c=t+s,r=e+o,l=0n;for(;c>=0&&c<8&&r>=0&&r<8;){const i=r*8+c;rn[n][i]=l,l|=1n<<BigInt(i),c+=s,r+=o}}}function ln(n,t,e){const s=t===0,o=J(t,n),c=J(s?1:0,n),r=s?1:0,l=n0(e,c)&Dn(n,r),i=b(e,c)&$n(n,r);let f=0n;function k(B){let E=B;for(;E;){const a=j(E);E&=E-1n;const I=rn[e][a]&o;I!==0n&&(I&I-1n)===0n&&(f|=I)}}return k(l),k(i),f}function fn(n){const t=n%8,e=Math.floor(n/8);return function(o){const c=o%8,r=Math.floor(o/8),l=c-t,i=r-e,f=l===0?0:l/Math.abs(l),k=i===0?0:i/Math.abs(i),B=f===0||k===0,E=Math.abs(l)===Math.abs(i);if(!(B||E))return 0n;let a=0n,u=t+f,I=e+k;for(;u>=0&&u<8&&I>=0&&I<8;){const h=I*8+u;a|=1n<<BigInt(h),u+=f,I+=k}return a}}const ot=[1,7,8,9,-1,-7,-8,-9],ct=n=>{let t=0n;for(const e of ot){const s=n+e;v0(s)&&rt(n,s)&&(t|=1n<<BigInt(s))}return t},rt=(n,t)=>{const e=n%8,s=t%8,o=Math.abs(e-s);return!(o!==1&&o!==0)},P0=(()=>{const n=new Array(64);for(let t=0;t<64;t++)n[t]=ct(t);return n})(),it=(n,t,e,s,o)=>{const c=Q(n),r=J(t,n);let l=n0(e,c);if(1n<<BigInt(e)&s){const f=o(e);l&=f}return l&~r},lt=(n,t,e,s,o)=>{const c=Q(n),r=J(t,n);let l=b(e,c)|n0(e,c);if(1n<<BigInt(e)&s){const f=o(e);l&=f}return l&~r},p0=(n,t,e,s,o=null)=>{const c=J(t,n);let r=P0[e]&~c;const l=t===0,i=Q(n);o&&(l?(o[_0]&&b0(0,s,i)&&(r|=1n<<6n),o[M0]&&nn(0,s,i)&&(r|=1n<<2n)):(o[T0]&&b0(1,s,i)&&(r|=1n<<62n),o[C0]&&nn(1,s,i)&&(r|=1n<<58n)));const f=1n<<BigInt(e);if(f&s){let k=r;for(;k;){const B=j(k),E=1n<<BigInt(B);k&=k-1n;let a=i;a&=~f,a|=E;const u=n0(B,a)&(l?n[M]|n[R]:n[_]|n[O]),I=b(B,a)&(l?n[Z]|n[R]:n[V]|n[O]);(u||I)&&(r&=~E)}}return r&~s},ft=(n,t,e,s,o,c)=>{const r=1n<<BigInt(e),l=t===0,i=Gn(n),f=l?l0(n):i0(n);let k=0n,B=0n,E=0n,a=0n;if(l){if(k=r<<8n&i,B=(r&0x000000000000ff00n)<<16n&i&i<<8n,E=B0[e]&f,s!==null){const u=1n<<BigInt(s);a=B0[e]&u}}else if(k=r>>8n&i,B=(r&0x00ff000000000000n)>>16n&i&i>>8n,E=x0[e]&f,s!==null){const u=1n<<BigInt(s);a=x0[e]&u}if(o&r){const u=c(e);k&=u,B&=u,E&=u,a&=u}if(a){const u=j(n[l?T:C]),I=u%8;if((u-I)/8-Math.floor(e/8)===0){const D=s,A=l?D-8:D+8,P=1n<<BigInt(A),N=Q(n)&~P&~r,W=n[l?M:_]|n[l?R:O];(In(N,u)&W)!==0n&&(a=0n)}}return k|B|E|a},ut=(n,t,e,s)=>{if(1n<<BigInt(e)&s)return 0n;let c=m0[e];const r=J(t,n);return c&~r},at=(n,t,e,s,o)=>{const c=Q(n),r=J(t,n);let l=b(e,c);if(1n<<BigInt(e)&s){const f=o(e);l&=f}return l&~r},un=(n,t,e,s,o,c,r,l,i)=>{let f=null;switch(t){case H:case Y:f=ft(n,s,e,o,l,i);break;case $:case o0:f=ut(n,s,e,l);break;case V:case Z:f=at(n,s,e,l,i);break;case _:case M:f=it(n,s,e,l,i);break;case O:case R:f=lt(n,s,e,l,i);break;case T:case C:f=p0(n,s,e,r,c);break;default:f=BigInt(0)}return f},an=(n,t,e,s)=>{let o=[];const c=t===0,l=f0(c?1:0),f=w[c?T:C][0],k=ln(n,t,f),B=fn(f);let E=~0n;if(l&1n<<BigInt(f)){const u=on(n,t,f),I=z0(u);if(I>1){const S=p0(n,t,f,l,e);return sn(S,f,c?T:C,s,t)}if(I!==1)throw new Error("KING IN CHECK W/O CHECKERS");const h=j(u);g[h]%6===$?E=u:E=cn(f,h)|u}const a=X0(t);for(const u of a){const I=g[u],h=un(n,I,u,t,s,e,l,k,B),S=I0(I)?h:h&E,D=sn(S,u,I,s,t);o=o.concat(D)}return o},En=(n,t)=>(t&1n<<BigInt(n))!==0n,Et=(n,t)=>{let e=T,s=1;t===1&&(e=C,s=0);const o=w[e][0],c=f0(s);return En(o,c)},kt=(n,t,e,s)=>{const o=t===0,c=o?1:0,r=f0(c),l=o?T:C,i=w[l][0];i===void 0&&(console.log(w[l],l),console.log(Z0(n,t,e,s)));const f=1n<<BigInt(i);if((f&r)===0n&&(P0[i]&~r&~Q(n))!==0n)return!0;const k=ln(n,t,i),B=fn(i);let E=~0n;if(r&f){const u=on(n,t,i),I=z0(u);if(I>1)return p0(n,t,i,r,e)!==0n;if(I!==1)throw console.log(Z0(n,t,e,s)),console.log(j0(r)),N0(n),console.log(j0(f0(c))),new Error("KING IN CHECK W/O CHECKERS");const h=j(u);g[h]%6===$?E=u:E=cn(i,h)|u}const a=X0(t);for(const u of a){const I=g[u],h=un(n,I,u,t,s,e,r,k,B);if((I0(I)?h:h&E)!==0n)return!0}return!1},kn=n=>{const t=n.piece;let e=null;if((t===H||t===Y)&&Math.abs(n.to-n.from)===16){const s=t===H?-8:8;e=n.to+s}return e};function y(n,t,e,s){let o=0n,c=n;for(;c=(c&e)<<t,!(!c||c===0n);){if(c&s){o|=c;break}o|=c}return o}function It(n,t){let e=1n<<BigInt(t),s=0n;return s|=y(e,9n,u0&E0,n),s|=y(e,7n,a0&E0,n),s|=y(e,-7n,u0&k0,n),s|=y(e,-9n,a0&k0,n),s}function In(n,t){let e=1n<<BigInt(t),s=0n;return s|=y(e,1n,u0,n),s|=y(e,-1n,a0,n),s|=y(e,8n,E0,n),s|=y(e,-8n,k0,n),s}const gn=Array.from({length:64},(n,t)=>gt(t)),Bn=Array.from({length:64},(n,t)=>Bt(t));function xn(n,t){return t*8+n}function gt(n){const t=n%8,e=Math.floor(n/8);let s=0n;const o=[[0,1],[0,-1],[1,0],[-1,0]];for(const[c,r]of o){let l=t+c,i=e+r;for(;l>=0&&l<8&&i>=0&&i<8;){const f=l+c,k=i+r;if(f>=8||f<0||k>=8||k<0)break;s|=1n<<BigInt(xn(l,i)),l+=c,i+=r}}return s}function Bt(n){const t=n%8,e=Math.floor(n/8);let s=0n;const o=[[1,1],[-1,1],[1,-1],[-1,-1]];for(const[c,r]of o){let l=t+c,i=e+r;for(;l>0&&l<7&&i>0&&i<7;)s|=1n<<BigInt(xn(l,i)),l+=c,i+=r}return s}const K0=[58,59,59,59,59,59,59,58,59,59,59,59,59,59,59,59,59,59,57,57,57,57,59,59,59,59,57,55,55,57,59,59,59,59,57,55,55,57,59,59,59,59,57,57,57,57,59,59,59,59,59,59,59,59,59,59,58,59,59,59,59,59,59,58],An=[0x1084200882008102n,0x818102100410000n,0x4064440182010000n,0x8108048110040402n,0x3604102800000108n,0x105042024040010n,0x4140c04260010n,0x8000208a080b4000n,0x40420288120084n,0x200900123040080n,0x8020140104030440n,0x260040400802108n,0x1c2040422000104n,0xa2020510081000n,0x1200084100a1002n,0x20008a20822008n,0x400c001120080102n,0x1020043032008100n,0x2a1002802002201n,0xc001008801490000n,0x2401008811400000n,0x2100800040602002n,0x302000043042002n,0x40820202012111n,0x1402180040084804n,0x228021044240800n,0x208088081040100n,0x528822008020020n,0x111200a0020080c0n,0x2808020480404600n,0x88010044440a00n,0x2002044002840380n,0x402108090020a000n,0x408011008040c41n,0x2021205010800n,0x404018a0120200n,0x40054010030101n,0x4008902100208084n,0x1008408100040905n,0x42004108014420n,0x8250c10022000n,0x2a084104001800n,0x30400a2002414n,0x200041a44000804n,0x4122000e0800c00n,0x1002201045008080n,0x30016801108080n,0x8402040400208080n,0x2801828808410000n,0x81010190040021n,0x300120203044000n,0x406020484240004n,0x4500001006020042n,0x400142428820010n,0x2440050800810004n,0x1842040c003000n,0x8420210090410n,0x200008841082000n,0x4c01000046080401n,0x11008000810c8801n,0x18003400a0042400n,0x20019020114100n,0x100402903010204n,0x4040190401020020n],W0=[52,53,53,53,53,53,52,52,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,52,53,53,53,53,53,53,52],hn=[0x8080008414400221n,0x504000100c200041n,0x1100200010484101n,0x2300200900100004n,0x1000a3500100800n,0x8200030810060004n,0xa00241800a20001n,0x2200009200410024n,0x2820800070844000n,0x38400320005000n,0x200260012c280n,0x2016801000480084n,0x4001000c11010801n,0xa0008c2001004n,0x14000110421804n,0x2025800049000080n,0x440008000482388n,0x801008c004422001n,0x9420008010002480n,0x802a0042002010n,0x401010004880230n,0xc02808004010600n,0xd40042019008n,0x8044220001008044n,0x804080010020c308n,0x8040600280400085n,0xd800200100104102n,0x4007002100100108n,0x1015050100080030n,0x1008540080420080n,0x4000110400221098n,0x818004600008304n,0x440002046800282n,0x100834000802001n,0x1060200501003040n,0x429809000800800n,0x240080c401800800n,0x4002011092000428n,0x400c031004002802n,0x114092000104n,0x8200c00480288004n,0x2810024220064000n,0x39002000110041n,0x3410100100090020n,0x400480091010014n,0x1402001008420064n,0x90a02a0001008080n,0x100400c0820005n,0x8041088040620200n,0x620020d1008200n,0xe60009000208080n,0x80b0018008001080n,0x340808801040080n,0x4409000884000300n,0x18201001c8020400n,0x0000800041000080n,0x2000110040660082n,0x4000210040098011n,0x82000104100a00dn,0x1002084500029n,0x201000c50020801n,0x82001004012822n,0x8008084090210204n,0x102044810406n],L0=Array(64),S0=Array(64);function*_n(n){for(let t=n;yield t,t!==0n;t=t-1n&n);}for(let n=0;n<64;n++){const t=gn[n],e=Bn[n],s=1<<64-W0[n],o=1<<64-K0[n];L0[n]=new Array(s),S0[n]=new Array(o);for(const c of _n(t)){const r=c&t,i=BigInt.asUintN(64,r*BigInt(hn[n]))>>BigInt(W0[n]),f=Number(i),k=In(c,n);L0[n][f]=k}for(const c of _n(e)){const r=Number(BigInt.asUintN(64,(c&e)*BigInt(An[n]))>>BigInt(K0[n])),l=It(c,n);S0[n][r]=l}}function b(n,t){const e=t&Bn[n],s=Number(BigInt.asUintN(64,e*An[n])>>BigInt(K0[n]));return S0[n][s]}function n0(n,t){const e=t&gn[n],s=Number(BigInt.asUintN(64,e*hn[n])>>BigInt(W0[n]));return L0[n][s]}function xt(n,t,e){switch(t){case H:return B0[e];case Y:return x0[e];case $:case o0:return m0[e];case T:case C:return P0[e];case V:case Z:return b(e,n);case _:case M:return n0(e,n);case O:case R:return b(e,n)|n0(e,n);default:return 0n}}function c0(n,t){let e=0n;const s=w[n];for(const o of s)e|=xt(t,n,o);return e}function N0(n){const t=Q(n);for(let e=0;e<G;e++)z[e]=c0(e,t);return z}const z=new BigUint64Array(G).fill(0n);N0(K);class Mn{constructor(t){this.cache=new Map,this.maxSize=t}get(t){if(!this.cache.has(t))return;const e=this.cache.get(t);return this.cache.delete(t),this.cache.set(t,e),e}set(t,e){if(this.cache.has(t))this.cache.delete(t);else if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;this.cache.delete(s)}this.cache.set(t,e)}has(t){return this.cache.has(t)}delete(t){return this.cache.delete(t)}clear(){this.cache.clear()}getSize(){return this.cache.size}}const Tn=1<<20,H0=new Mn(Tn),F={EXACT:0,LOWER_BOUND:1,UPPER_BOUND:2},Cn=()=>{H0.clear()},At=n=>H0.get(n),ht=(n,t)=>{H0.set(n,t)},O0=new Mn(Tn),_t=()=>{O0.clear()},Mt=n=>O0.get(n),Tt=(n,t)=>{O0.set(n,t)};function t0(){const n=Math.floor(Math.random()*4294967296),t=Math.floor(Math.random()*4294967296);return BigInt(n)<<32n|BigInt(t)}const q=new BigUint64Array(G*64);for(let n=0;n<G;n++)for(let t=0;t<64;t++)q[n*64+t]=t0();const R0=Array(8).fill(null).map(()=>t0()),Ct=[t0(),t0(),t0(),t0()],wn=t0(),wt=(n,t,e=null,s=null)=>{let o=0n;const c=V0();for(const r of c){const l=g[r];o^=q[l*64+r]}if(t===1&&(o^=wn),e>=0&&(o^=R0[e]),s)for(let r=0;r<s.length;r++)s[r]&&(o^=Ct[r]);return o},mn=(n,t,e,s,o)=>{let c=n;const r=t.from,l=t.to,i=t.captured,f=q[t.piece*64+r];c^=f;const k=t.promotion?t.promotion:t.piece,B=q[k*64+l];if(c^=B,i!==null){const E=q[i*64+l];c^=E}if(c^=wn,e!==s&&(e>=0&&(c^=R0[e]),s>=0&&(c^=R0[s])),t.castling){const E=r===4,a=E?_:M;if(r>l){const u=E?0:56;c^=q[a*64+u];const I=u+3;c^=q[a*64+I]}else{const u=E?7:63;c^=q[a*64+u];const I=u-2;c^=q[a*64+I]}}for(let E=0;E<o.length;E++)o[E]&&(c^=Rn[E]);return c},Pn=(n,t,e,s,o)=>{const c=t===0,r=c?1:0,l=f0(t),i={isGameOver:!1,result:null};if(mt(n))return i.isGameOver=!0,i.result="Draw by Insufficient Material",i;if(Pt(e))return i.isGameOver=!0,i.result="Draw by Repetition",i;if(!kt(n,r,null,s)){i.isGameOver=!0;const k=w[c?C:T][0];if(En(k,l)){const B=c?"White":"Black";return i.result=`${B} Wins by Checkmate`,i}return i.result="Draw by Stalemate",i}return i},mt=n=>{const t=i0(n),e=l0(n),s=n[O]|n[R],o=n[_]|n[M],c=n[H]|n[Y];return(s|o|c)!==0n?!1:y0(t)<=2&&y0(e)<=2},Pt=n=>{for(let t of n.values())if(t>=3)return!0;return!1},pt=[[0,0,0,0,0,0,0,0,5,10,10,-20,-20,10,10,5,5,-5,-10,0,0,-10,-5,5,0,0,10,20,20,0,0,0,5,5,10,25,25,10,5,5,10,10,20,30,30,20,10,10,50,50,50,50,50,50,50,50,0,0,0,0,0,0,0,0],[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,5,5,0,-20,-40,-30,5,20,15,15,20,5,-30,-30,0,15,25,25,15,0,-30,-30,5,15,25,25,15,5,-30,-30,0,10,15,15,10,0,-30,-40,-20,0,0,0,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],[-20,-10,-10,-10,-10,-10,-10,-20,-10,5,0,0,0,0,5,-10,-10,10,10,10,10,10,10,-10,-10,0,10,10,10,10,0,-10,-10,5,5,10,10,5,5,-10,-10,0,5,10,10,5,0,-10,-10,0,0,0,0,0,0,-10,-20,-10,-10,-10,-10,-10,-10,-20],[0,0,5,10,10,5,0,0,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,5,10,10,10,10,10,10,5,0,0,0,0,0,0,0,0],[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,5,0,-10,-10,0,5,5,5,5,5,-10,-5,0,5,5,5,5,0,0,-5,0,5,5,5,5,0,-5,-10,0,5,5,5,5,0,-10,-10,0,0,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],[20,30,10,0,0,10,30,20,20,20,0,0,0,0,20,20,-10,-20,-20,-20,-20,-20,-20,-10,-20,-30,-30,-40,-40,-30,-30,-20,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30],[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,10,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0],[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,25,25,15,5,-30,-30,0,15,25,25,15,0,-30,-30,5,20,15,15,20,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],[-20,-10,-10,-10,-10,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,10,10,5,0,-10,-10,5,5,10,10,5,5,-10,-10,0,10,10,10,10,0,-10,-10,10,10,10,10,10,10,-10,-10,5,0,0,0,0,5,-10,-20,-10,-10,-10,-10,-10,-10,-20],[0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,0,0,0,5,5,0,0,0],[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,0,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20]],d0=(n,t,e)=>{if(t)return t.includes("Checkmate")?-F0+e:0;let s=0;const o=V0();for(const c of o){const r=g[c],l=r<6?1:-1;s+=l*(r0[r%6]+pt[r][c])}return n===0?s:-s},r0=[100,320,330,500,900,2e4],Kt=(n,t,e)=>an(n,t,null,e).filter(o=>o.captured!==null||o.promotion),U0=10,pn=Array.from({length:U0},()=>[null,null]),Kn=Array.from({length:64},()=>Array(64).fill(0)),Wn=(n,t,e,s,o,c,r,l,i=0)=>{const f=t===0?1:0,k=Pn(n,f,r,o);if(k.isGameOver)return{score:d0(f,k.result,0),move:null};const B=d0(t,null,0);if(i+1>U0)return{score:B,move:null};if(B>=s)return{score:s,move:null};const E=e;e=Math.max(e,B);const a=Mt(l),u=U0-i;if(a&&a.depth>=u&&a.isQuiescence){if(a.flag===F.EXACT)return{score:a.value,move:null};if(a.flag===F.LOWER_BOUND&&a.value>e?e=a.value:a.flag===F.UPPER_BOUND&&a.value<s&&(s=a.value),e>=s)return{score:a.value,move:null}}const I=(a==null?void 0:a.bestMove)||null,h=Kt(n,t,o).map(A=>{let P=0;const N=A.from,W=A.to;I&&N===I.from&&W===I.to&&(P+=1e6),A.captured&&(P+=1e5+(r0[A.captured%6]||0)-(r0[A.piece%6]||0));const[x,p]=pn[i];return x&&N===x.from&&W===x.to?P+=9e4:p&&N===p.from&&W===p.to&&(P+=8e4),P+=Kn[N][W],{move:A,score:P}});h.sort((A,P)=>P.score-A.score);const S=h.map(A=>A.move);for(const A of S){const P=r0[A.captured%6]||0;if(B+P<=e)continue;tn(n,A);const N=kn(A),W=J0(A.from,A.to,c),x=N?N%8:-1,p=o?o%8:-1,v=new Array(W.length);for(let m=0;m<W.length;m++)c[m]!==W[m]?v[m]=!0:v[m]=!1;const L=mn(l,A,x,p,v),X=r.get(L)||0;r.set(L,X+1);const{score:e0}=Wn(n,f,-s,-e,N,W,r,L,i+1);en(A,n),X?r.set(L,X):r.delete(L);const s0=-e0;if(s0>=s)return{score:s,move:null};if(s0>e&&(e=s0),s<=e){if(A.captured===null){const m=pn[i];(!m[0]||A.from!==m[0].from||A.to!==m[0].to)&&(m[1]=m[0],m[0]=A),Kn[A.from][A.to]+=2^u}break}}let D=F.EXACT;return e<=E?D=F.UPPER_BOUND:e>=s&&(D=F.LOWER_BOUND),Tt(l,{value:e,depth:u,flag:D,isQuiescence:!0}),{score:e,move:null}},Ln=Array.from({length:dn},()=>[null,null]),Sn=Array.from({length:64},()=>Array(64).fill(0)),Nn=(n,t,e,s,o,c,r,l,i,f)=>{const k=t===0?1:0,B=Pn(n,k,o,s);if(B.isGameOver)return{score:d0(k,B.result,r),move:null};if(r>=l&&(!Et(n,t)||r!==l))return{score:Wn(n,t,i,f,s,e,o,c).score,move:null};const E=c,a=i,u=l-r,I=At(E);if(I&&I.depth>=u&&I.rootId===A0){if(I.flag===F.EXACT)return{score:I.value,move:I.bestMove};if(I.flag===F.LOWER_BOUND&&(i=Math.max(i,I.value)),I.flag===F.UPPER_BOUND&&(f=Math.min(f,I.value)),i>=f)return{score:I.value,move:I.bestMove}}const h=(I==null?void 0:I.bestMove)||null,S=an(n,t,e,s).map(x=>{let p=0;const v=x.from,L=x.to;h&&v===h.from&&L===h.to&&(p+=1e6),x.captured&&(p+=1e5+(r0[x.captured%6]||0)-(r0[x.piece%6]||0));const[X,e0]=Ln[r];return X&&v===X.from&&L===X.to?p+=9e4:e0&&v===e0.from&&L===e0.to&&(p+=8e4),p+=Sn[v][L],{move:x,score:p}});if(S.length===0)throw new Error("Issue with move generation. No moves generated");S.sort((x,p)=>p.score-x.score);const D=S.map(x=>x.move);let A=-1/0,P=null;for(const x of D){tn(n,x);const p=x.from,v=kn(x),L=J0(p,x.to,e),X=v?v%8:-1,e0=s?s%8:-1,s0=new Array(L.length);for(let d=0;d<L.length;d++)e[d]!==L[d]?s0[d]=!0:s0[d]=!1;const m=mn(c,x,X,e0,s0),Q0=o.get(m)||0;o.set(m,Q0+1);const{score:Lt}=Nn(n,k,L,v,o,m,r+1,l,-f,-i);en(x,n),Q0?o.set(m,Q0):o.delete(m);const h0=-Lt;if(h0>A&&(A=h0,P=x),h0>i&&(i=h0),f<=i){if(x.captured===null){const d=Ln[r];(!d[0]||x.from!==d[0].from||x.to!==d[0].to)&&(d[1]=d[0],d[0]=x),Sn[x.from][x.to]+=2^l-r}break}}let N=F.EXACT;const W=A;return W<=a?N=F.UPPER_BOUND:W>=f&&(N=F.LOWER_BOUND),ht(E,{rootId:A0,depth:l-r,value:W,flag:N,bestMove:P}),{score:A,move:P}};let A0=0;function Wt(n,t,e,s,o,c,r=1/0){Cn(),_t();const l=performance.now();let i=null,f=null;const k=s?s%8:-1,B=wt(n,t,k,e);A0=0;for(let E=1;E<=c;E++){const{score:a,move:u}=Nn(n,t,e,s,o,B,0,E,-1/0,1/0);if(u!==null&&(f=a,i=u),Math.abs(a)>F0-E&&u||performance.now()-l>r)break;A0++}return{...i,bestEval:f}}onmessage=n=>{const{bitboards:t,player:e,castlingRights:s,enPassantSquare:o,prevPositions:c,maxDepth:r,timeLimit:l}=n.data;Cn(),Y0(t),D0(t),N0(t);const i=Wt(t,e,s,o,c,r,l);postMessage({move:i})}})();
