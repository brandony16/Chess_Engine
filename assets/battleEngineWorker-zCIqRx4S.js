(function(){"use strict";const S0=n=>{let e;const t=new Set,o=(f,g)=>{const E=typeof f=="function"?f(e):f;if(!Object.is(E,e)){const d=e;e=g??(typeof E!="object"||E===null)?E:Object.assign({},e,E),t.forEach(u=>u(e,d))}},s=()=>e,l={setState:o,getState:s,getInitialState:()=>i,subscribe:f=>(t.add(f),()=>t.delete(f))},i=e=n(o,s,l);return l},$e=n=>n?S0(n):S0;function je(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var C0={exports:{}},v={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Cn=Symbol.for("react.element"),ze=Symbol.for("react.portal"),De=Symbol.for("react.fragment"),Xe=Symbol.for("react.strict_mode"),qe=Symbol.for("react.profiler"),Ye=Symbol.for("react.provider"),Je=Symbol.for("react.context"),Ze=Symbol.for("react.forward_ref"),be=Symbol.for("react.suspense"),nt=Symbol.for("react.memo"),et=Symbol.for("react.lazy"),O0=Symbol.iterator;function tt(n){return n===null||typeof n!="object"?null:(n=O0&&n[O0]||n["@@iterator"],typeof n=="function"?n:null)}var P0={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},T0=Object.assign,R0={};function _n(n,e,t){this.props=n,this.context=e,this.refs=R0,this.updater=t||P0}_n.prototype.isReactComponent={},_n.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,n,e,"setState")},_n.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function N0(){}N0.prototype=_n.prototype;function Zn(n,e,t){this.props=n,this.context=e,this.refs=R0,this.updater=t||P0}var bn=Zn.prototype=new N0;bn.constructor=Zn,T0(bn,_n.prototype),bn.isPureReactComponent=!0;var L0=Array.isArray,U0=Object.prototype.hasOwnProperty,n0={current:null},K0={key:!0,ref:!0,__self:!0,__source:!0};function F0(n,e,t){var o,s={},c=null,r=null;if(e!=null)for(o in e.ref!==void 0&&(r=e.ref),e.key!==void 0&&(c=""+e.key),e)U0.call(e,o)&&!K0.hasOwnProperty(o)&&(s[o]=e[o]);var l=arguments.length-2;if(l===1)s.children=t;else if(1<l){for(var i=Array(l),f=0;f<l;f++)i[f]=arguments[f+2];s.children=i}if(n&&n.defaultProps)for(o in l=n.defaultProps,l)s[o]===void 0&&(s[o]=l[o]);return{$$typeof:Cn,type:n,key:c,ref:r,props:s,_owner:n0.current}}function ot(n,e){return{$$typeof:Cn,type:n.type,key:e,ref:n.ref,props:n.props,_owner:n._owner}}function e0(n){return typeof n=="object"&&n!==null&&n.$$typeof===Cn}function st(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var W0=/\/+/g;function t0(n,e){return typeof n=="object"&&n!==null&&n.key!=null?st(""+n.key):e.toString(36)}function Kn(n,e,t,o,s){var c=typeof n;(c==="undefined"||c==="boolean")&&(n=null);var r=!1;if(n===null)r=!0;else switch(c){case"string":case"number":r=!0;break;case"object":switch(n.$$typeof){case Cn:case ze:r=!0}}if(r)return r=n,s=s(r),n=o===""?"."+t0(r,0):o,L0(s)?(t="",n!=null&&(t=n.replace(W0,"$&/")+"/"),Kn(s,e,t,"",function(f){return f})):s!=null&&(e0(s)&&(s=ot(s,t+(!s.key||r&&r.key===s.key?"":(""+s.key).replace(W0,"$&/")+"/")+n)),e.push(s)),1;if(r=0,o=o===""?".":o+":",L0(n))for(var l=0;l<n.length;l++){c=n[l];var i=o+t0(c,l);r+=Kn(c,e,t,i,s)}else if(i=tt(n),typeof i=="function")for(n=i.call(n),l=0;!(c=n.next()).done;)c=c.value,i=o+t0(c,l++),r+=Kn(c,e,t,i,s);else if(c==="object")throw e=String(n),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return r}function Fn(n,e,t){if(n==null)return n;var o=[],s=0;return Kn(n,o,"","",function(c){return e.call(t,c,s++)}),o}function rt(n){if(n._status===-1){var e=n._result;e=e(),e.then(function(t){(n._status===0||n._status===-1)&&(n._status=1,n._result=t)},function(t){(n._status===0||n._status===-1)&&(n._status=2,n._result=t)}),n._status===-1&&(n._status=0,n._result=e)}if(n._status===1)return n._result.default;throw n._result}var j={current:null},Wn={transition:null},ct={ReactCurrentDispatcher:j,ReactCurrentBatchConfig:Wn,ReactCurrentOwner:n0};function H0(){throw Error("act(...) is not supported in production builds of React.")}v.Children={map:Fn,forEach:function(n,e,t){Fn(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return Fn(n,function(){e++}),e},toArray:function(n){return Fn(n,function(e){return e})||[]},only:function(n){if(!e0(n))throw Error("React.Children.only expected to receive a single React element child.");return n}},v.Component=_n,v.Fragment=De,v.Profiler=qe,v.PureComponent=Zn,v.StrictMode=Xe,v.Suspense=be,v.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=ct,v.act=H0,v.cloneElement=function(n,e,t){if(n==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+n+".");var o=T0({},n.props),s=n.key,c=n.ref,r=n._owner;if(e!=null){if(e.ref!==void 0&&(c=e.ref,r=n0.current),e.key!==void 0&&(s=""+e.key),n.type&&n.type.defaultProps)var l=n.type.defaultProps;for(i in e)U0.call(e,i)&&!K0.hasOwnProperty(i)&&(o[i]=e[i]===void 0&&l!==void 0?l[i]:e[i])}var i=arguments.length-2;if(i===1)o.children=t;else if(1<i){l=Array(i);for(var f=0;f<i;f++)l[f]=arguments[f+2];o.children=l}return{$$typeof:Cn,type:n.type,key:s,ref:c,props:o,_owner:r}},v.createContext=function(n){return n={$$typeof:Je,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},n.Provider={$$typeof:Ye,_context:n},n.Consumer=n},v.createElement=F0,v.createFactory=function(n){var e=F0.bind(null,n);return e.type=n,e},v.createRef=function(){return{current:null}},v.forwardRef=function(n){return{$$typeof:Ze,render:n}},v.isValidElement=e0,v.lazy=function(n){return{$$typeof:et,_payload:{_status:-1,_result:n},_init:rt}},v.memo=function(n,e){return{$$typeof:nt,type:n,compare:e===void 0?null:e}},v.startTransition=function(n){var e=Wn.transition;Wn.transition={};try{n()}finally{Wn.transition=e}},v.unstable_act=H0,v.useCallback=function(n,e){return j.current.useCallback(n,e)},v.useContext=function(n){return j.current.useContext(n)},v.useDebugValue=function(){},v.useDeferredValue=function(n){return j.current.useDeferredValue(n)},v.useEffect=function(n,e){return j.current.useEffect(n,e)},v.useId=function(){return j.current.useId()},v.useImperativeHandle=function(n,e,t){return j.current.useImperativeHandle(n,e,t)},v.useInsertionEffect=function(n,e){return j.current.useInsertionEffect(n,e)},v.useLayoutEffect=function(n,e){return j.current.useLayoutEffect(n,e)},v.useMemo=function(n,e){return j.current.useMemo(n,e)},v.useReducer=function(n,e,t){return j.current.useReducer(n,e,t)},v.useRef=function(n){return j.current.useRef(n)},v.useState=function(n){return j.current.useState(n)},v.useSyncExternalStore=function(n,e,t){return j.current.useSyncExternalStore(n,e,t)},v.useTransition=function(){return j.current.useTransition()},v.version="18.3.1",C0.exports=v;var it=C0.exports,Q0=je(it);const lt=n=>n;function ft(n,e=lt){const t=Q0.useSyncExternalStore(n.subscribe,()=>e(n.getState()),()=>e(n.getInitialState()));return Q0.useDebugValue(t),t}const V0=n=>{const e=$e(n),t=o=>ft(e,o);return Object.assign(t,e),t},ut=n=>n?V0(n):V0,_=0,Q=1,q={wP:0,wN:1,wB:2,wR:3,wQ:4,wK:5,bP:6,bN:7,bB:8,bR:9,bQ:10,bK:11},b=12,G=0,en=1,sn=2,N=3,z=4,F=5,J=6,hn=7,rn=8,L=9,D=10,W=11,U=new BigUint64Array(b);U[q.wP]=BigInt("0x000000000000FF00"),U[q.wN]=BigInt("0x0000000000000042"),U[q.wB]=BigInt("0x0000000000000024"),U[q.wR]=BigInt("0x0000000000000081"),U[q.wQ]=BigInt("0x0000000000000008"),U[q.wK]=BigInt("0x0000000000000010"),U[q.bP]=BigInt("0x00FF000000000000"),U[q.bN]=BigInt("0x4200000000000000"),U[q.bB]=BigInt("0x2400000000000000"),U[q.bR]=BigInt("0x8100000000000000"),U[q.bQ]=BigInt("0x0800000000000000"),U[q.bK]=BigInt("0x1000000000000000");const Hn=0x7f7f7f7f7f7f7f7fn,Qn=0xfefefefefefefefen,Vn=0x00ffffffffffffffn,Gn=0xffffffffffffff00n,at={0:"P",1:"N",2:"B",3:"R",4:"Q",5:"K",6:"p",7:"n",8:"b",9:"r",10:"q",11:"k"},gt={0:"P",1:"N",2:"B",3:"R",4:"Q",5:"K",6:"P",7:"N",8:"B",9:"R",10:"Q",11:"K"},o0={0:"a",1:"b",2:"c",3:"d",4:"e",5:"f",6:"g",7:"h"},mt={a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7},dt=[0xabc123n,0xdef456n,0x789abcn,0x123defn],s0=0,r0=1,c0=2,i0=3,xn=[1,3,3,5,9,1e3,-1,-3,-3,-5,-9,-1e3],cn=1e5,l0=32,Et=[z,N,sn,en],kt=[D,L,rn,hn],pt=[{df:1,dr:0},{df:-1,dr:0},{df:0,dr:1},{df:0,dr:-1},{df:1,dr:1},{df:-1,dr:1},{df:1,dr:-1},{df:-1,dr:-1}],G0=n=>n>=0&&n<64,Bt=0x03f79d71b4cb0a89n,Mt=[0,1,48,2,57,49,28,3,61,58,50,42,38,29,17,4,62,55,59,36,53,51,43,22,45,39,33,30,24,18,12,5,63,47,56,27,60,41,37,16,54,35,52,21,44,32,23,11,46,26,40,15,34,20,31,10,25,14,19,9,13,8,7,6],ln=n=>{if(n===0n)return-1;const e=n&-n,t=BigInt.asUintN(64,e*Bt),o=Number(t>>58n);return Mt[o]},$0=n=>{let e=0;for(;n;)n&=n-1n,e++;return e},On=n=>n===F||n===W,j0=n=>!(n%6===G||n%6===en||On(n));function z0(n){let e=0;for(;n!==0n;)n&=n-1n,e++;return e}const Pn=n=>n[G]|n[en]|n[sn]|n[N]|n[z]|n[F],Tn=n=>n[J]|n[hn]|n[rn]|n[L]|n[D]|n[W],Y=n=>BigInt(Pn(n)|Tn(n)),gn=(n,e)=>n===_?Pn(e):Tn(e),It=n=>~(Pn(n)|Tn(n)),I=new Array(64).fill(null);function f0(n){_t();for(let e=0;e<b;e++){let t=n[e];for(;t;){const o=ln(t);I[o]=e,t&=t-1n}}}function _t(){for(let n=0;n<64;n++)I[n]=null}f0(U);function ht(n,e){return e===_?n[N]|n[z]:n[L]|n[D]}function xt(n,e){return e===_?n[sn]|n[z]:n[rn]|n[D]}const H=Array.from({length:b},()=>[]);u0(U);function D0(n){const{piece:e,from:t,to:o,captured:s,promotion:c,enPassant:r,castling:l}=n,i=H[e];if(c!==null?(H[c].push(o),i.splice(i.indexOf(t),1)):i[i.indexOf(t)]=o,s!==null){const f=H[s];if(r){const g=o>t?o-8:o+8;f.splice(f.indexOf(g),1)}else f.splice(f.indexOf(o),1)}if(l)if(t===4){const f=H[N];o===6?f[f.indexOf(7)]=5:f[f.indexOf(0)]=3}else{const f=H[L];o===62?f[f.indexOf(63)]=61:f[f.indexOf(56)]=59}}function X0(n){const{piece:e,from:t,to:o,captured:s,promotion:c,enPassant:r,castling:l}=n,i=H[e];if(c){const f=H[c];f.splice(f.indexOf(o),1),i.push(t)}else i[i.indexOf(o)]=t;if(s!==null){const f=H[s];if(r){const g=o>t?o-8:o+8;f.push(g)}else f.push(o)}if(l)if(t===4){const f=H[N];o===6?f[f.indexOf(5)]=7:f[f.indexOf(3)]=0}else{const f=H[L];o===62?f[f.indexOf(61)]=63:f[f.indexOf(59)]=56}}function q0(n){const e=n===_?0:6,t=[];for(let o=e;o<e+6;o++)t.push(...H[o]);return t}function Rn(){let n=[];for(let e=0;e<b;e++)n.push(...H[e]);return n}function u0(n){for(let e=0;e<b;e++)H[e].length=0;for(let e=0;e<b;e++){let t=n[e];const o=H[e];for(;t;){const s=ln(t);o.push(s),t&=t-1n}}}function Y0(n){let e="";for(let t=7;t>=0;t--){let o="";for(let s=0;s<8;s++){let c=BigInt(1)<<BigInt(t*8+s);o+=n&c?"1 ":"0 "}e+=o.trim()+`
`}return e}function J0(n,e,t,o){const s=[];for(let E=7;E>=0;E--){let d="",u=0;for(let m=0;m<8;m++){const a=E*8+m,B=I[a];B===null?u+=1:(u&&(d+=u,u=0),d+=at[B])}u&&(d+=u),s.push(d)}const c=s.join("/"),r=e===_?"w":"b",l="-",i=o!==null?wt(o):"-";return`${c} ${r} ${l} ${i} 0 1`}function wt(n){const e=Math.floor(n/8)+1,t=n%8;return""+o0[t]+e}function Z0(n){const e=n.charAt(0),t=n.charAt(1),o=parseInt(t)-1,s=mt[e];return o*8+s}async function At(){const n=await fetch("../../../openings.json");if(!n.ok)throw new Error("Error fetching opening moves");const e=await n.json(),t=Math.floor(Math.random()*e.length);return e[t]}class $n{constructor(e,t,o,s,c,r,l){this.from=e,this.to=t,this.piece=o,this.captured=s,this.promotion=c,this.castling=r,this.enPassant=l}copyWith({from:e,to:t,piece:o,captured:s,promotion:c,castling:r,enPassant:l}){return new $n(e??this.from,t??this.to,o??this.piece,s??this.captured,c??this.promotion,r??this.castling,l??this.enPassant)}}const mn=(n,e)=>{const t=1n,o=t<<BigInt(e.from),s=t<<BigInt(e.to),c=e.piece,r=e.captured,l=e.promotion,i=e.enPassant;if(Y(n),e.castling){qt(n,e);return}if(n[c]&=~o,e.captured!==null&&!i&&(n[r]&=~s),I[e.from]=null,l?(n[l]|=s,I[e.to]=l):(n[c]|=s,I[e.to]=c),i){const f=c===G?-8:8;n[r]&=~(t<<BigInt(e.to+f)),I[e.to+f]=null}D0(e),Dn(n,e)},wn=(n,e)=>{const t=n.from,o=n.to,s=1n,c=s<<BigInt(t),r=s<<BigInt(o),l=n.piece,i=n.captured,f=n.promotion,g=n.enPassant;if(n.castling){Yt(e,n);return}if(I[o]=null,I[t]=l,f?(e[f]&=~r,e[l]|=c):(e[l]&=~r,e[l]|=c),i!==null&&!g&&(e[i]|=r,I[o]=i),g){const d=o+(l===G?-8:8);e[i]|=s<<BigInt(d),I[d]=i}X0(n),Dn(e,n)},yt=(n,e,t,o)=>{const s=t<=5,c=On(t)&&Math.abs(n-e)===2,r=e===o&&(t===G||t===J);let l=I[e];return r&&(l=s?J:G),new $n(n,e,t,l,null,c,r)},b0=(n,e,t,o,s)=>{const c=[],r=s===_?6:1,i=Math.floor(e/8)===r&&t%6===G;let f=n;for(;f!==0n;){const g=ln(f);f&=f-1n;const E=yt(e,g,t,o);if(i){const d=s===_?Et:kt;for(const u of d){const m=E.copyWith({promotion:u});c.push(m)}}else c.push(E)}return c},vt=n=>{const e=1n<<BigInt(n);let t=0n;return n%8!==0&&(t|=e<<7n),n%8!==7&&(t|=e<<9n),t},St=n=>{const e=1n<<BigInt(n);let t=0n;return n%8!==0&&(t|=e>>9n),n%8!==7&&(t|=e>>7n),t},jn=(()=>{const n=new Array(64);for(let e=0;e<64;e++)n[e]=vt(e);return n})(),zn=(()=>{const n=new Array(64);for(let e=0;e<64;e++)n[e]=St(e);return n})(),Ct=[17,15,10,6,-17,-15,-10,-6],Ot=n=>{let e=0n;for(const t of Ct){const o=n+t;G0(o)&&Pt(n,o)&&(e|=1n<<BigInt(o))}return e},Pt=(n,e)=>{const t=n%8,o=e%8,s=Math.abs(t-o);return!(s!==1&&s!==2)},a0=(()=>{const n=new Array(64);for(let e=0;e<64;e++)n[e]=Ot(e);return n})();function ne(n,e,t){const o=e===_,s=n[o?J:G],c=(o?jn[t]:zn[t])&s,r=n[o?hn:en],l=a0[t]&r,i=Tt(n,t,Y(n),o);return c|l|i}function Tt(n,e,t,o){let s=0n,r=kn(e,t)&t;const l=o?n[L]|n[D]:n[N]|n[z];s|=r&l;let f=En(e,t)&t;const g=o?n[rn]|n[D]:n[sn]|n[z];return s|=g&f,s}function ee(n,e){if(n===e)return 0n;const t=n%8,o=(n-t)/8,s=e%8,r=(e-s)/8-o,l=s-t,i=r===0?0:r/Math.abs(r),f=l===0?0:l/Math.abs(l),g=1n<<BigInt(n),E=1n<<BigInt(e),d=r>0?Vn:Gn,u=l>0?Hn:Qn,m=g|E;if(r===0)return Z(g,BigInt(f),u,m)&~E;if(l===0)return Z(g,BigInt(i*8),d,m)&~E;if(Math.abs(r)!==Math.abs(l))throw new Error(`No compass direction between ${n} & ${e}`);return Z(g,BigInt(i*8+f),d&u,m)&~E}const te=Array.from({length:64},()=>Array(64).fill(0n));for(let n=0;n<64;n++){const e=n%8,t=Math.floor(n/8);for(const{df:o,dr:s}of pt){let c=e+o,r=t+s,l=0n;for(;c>=0&&c<8&&r>=0&&r<8;){const i=r*8+c;te[n][i]=l,l|=1n<<BigInt(i),c+=o,r+=s}}}function oe(n,e,t){const o=e===_,s=gn(e,n),c=gn(o?Q:_,n),r=o?Q:_,l=kn(t,c)&ht(n,r),i=En(t,c)&xt(n,r);let f=0n;function g(E){let d=E;for(;d;){const u=ln(d);d&=d-1n;const a=te[t][u]&s;a!==0n&&(a&a-1n)===0n&&(f|=a)}}return g(l),g(i),f}function se(n){const e=n%8,t=Math.floor(n/8);return function(s){const c=s%8,r=Math.floor(s/8),l=c-e,i=r-t,f=l===0?0:l/Math.abs(l),g=i===0?0:i/Math.abs(i),E=f===0||g===0,d=Math.abs(l)===Math.abs(i);if(!(E||d))return 0n;let u=0n,m=e+f,a=t+g;for(;m>=0&&m<8&&a>=0&&a<8;){const B=a*8+m;u|=1n<<BigInt(B),m+=f,a+=g}return u}}const Rt=[1,7,8,9,-1,-7,-8,-9],Nt=n=>{let e=0n;for(const t of Rt){const o=n+t;G0(o)&&Lt(n,o)&&(e|=1n<<BigInt(o))}return e},Lt=(n,e)=>{const t=n%8,o=e%8,s=Math.abs(t-o);return!(s!==1&&s!==0)},g0=(()=>{const n=new Array(64);for(let e=0;e<64;e++)n[e]=Nt(e);return n})(),Ut=(n,e,t,o,s)=>{const c=Y(n),r=gn(e,n);let l=kn(t,c);if(1n<<BigInt(t)&o){const f=s(t);l&=f}return l&~r},Kt=(n,e,t,o,s)=>{const c=Y(n),r=gn(e,n);let l=En(t,c)|kn(t,c);if(1n<<BigInt(t)&o){const f=s(t);l&=f}return l&~r},m0=(n,e,t,o,s=null)=>{const c=gn(e,n);let r=g0[t]&~c;const l=e===_,i=Y(n);s&&(l?(s[s0]&&de(_,o,i)&&(r|=1n<<6n),s[r0]&&Ee(_,o,i)&&(r|=1n<<2n)):(s[c0]&&de(Q,o,i)&&(r|=1n<<62n),s[i0]&&Ee(Q,o,i)&&(r|=1n<<58n)));const f=1n<<BigInt(t);if(f&o){let g=r;for(;g;){const E=ln(g),d=1n<<BigInt(E);g&=g-1n;let u=i;u&=~f,u|=d;const m=kn(E,u)&(l?n[L]|n[D]:n[N]|n[z]),a=En(E,u)&(l?n[rn]|n[D]:n[sn]|n[z]);(m||a)&&(r&=~d)}}return r&~o},Ft=(n,e,t,o,s,c)=>{const r=1n<<BigInt(t),l=e===_,i=It(n),f=l?Tn(n):Pn(n);let g=0n,E=0n,d=0n,u=0n;if(l){if(g=r<<8n&i,E=(r&0x000000000000ff00n)<<16n&i&i<<8n,d=jn[t]&f,o!==null){const m=1n<<BigInt(o);u=jn[t]&m}}else if(g=r>>8n&i,E=(r&0x00ff000000000000n)>>16n&i&i>>8n,d=zn[t]&f,o!==null){const m=1n<<BigInt(o);u=zn[t]&m}if(s&r){const m=c(t);g&=m,E&=m,d&=m,u&=m}if(u){const m=ln(n[l?F:W]),a=m%8;if((m-a)/8-Math.floor(t/8)===0){const R=o,p=l?R-8:R+8,A=1n<<BigInt(p),C=Y(n)&~A&~r,M=n[l?L:N]|n[l?D:z];(ie(C,m)&M)!==0n&&(u=0n)}}return g|E|d|u},Wt=(n,e,t,o)=>{if(1n<<BigInt(t)&o)return 0n;let c=a0[t];const r=gn(e,n);return c&~r},Ht=(n,e,t,o,s)=>{const c=Y(n),r=gn(e,n);let l=En(t,c);if(1n<<BigInt(t)&o){const f=s(t);l&=f}return l&~r},re=(n,e,t,o,s,c,r,l,i)=>{let f=null;switch(e){case G:case J:f=Ft(n,o,t,s,l,i);break;case en:case hn:f=Wt(n,o,t,l);break;case sn:case rn:f=Ht(n,o,t,l,i);break;case N:case L:f=Ut(n,o,t,l,i);break;case z:case D:f=Kt(n,o,t,l,i);break;case F:case W:f=m0(n,o,t,r,c);break;default:f=BigInt(0)}return f},dn=(n,e,t,o)=>{let s=[];const c=e===_,l=Ln(c?Q:_),f=H[c?F:W][0],g=oe(n,e,f),E=se(f);let d=~0n;if(l&1n<<BigInt(f)){const m=ne(n,e,f),a=z0(m);if(a>1){const S=m0(n,e,f,l,t);return b0(S,f,c?F:W,o,e)}if(a!==1)throw new Error("KING IN CHECK W/O CHECKERS");const B=ln(m);I[B]%6===en?d=m:d=ee(f,B)|m}const u=q0(e);for(const m of u){const a=I[m],B=re(n,a,m,e,o,t,l,g,E),S=On(a)?B:B&d,R=b0(S,m,a,o,e);s=s.concat(R)}return s},ce=(n,e)=>(e&1n<<BigInt(n))!==0n,Nn=(n,e)=>{let t=F,o=Q;e===Q&&(t=W,o=_);const s=H[t][0],c=Ln(o);return ce(s,c)},Qt=(n,e,t,o)=>{const s=e===_,c=s?Q:_,r=Ln(c),l=s?F:W,i=H[l][0];i===void 0&&(console.log(H[l],l),console.log(J0(n,e,t,o)));const f=1n<<BigInt(i);if((f&r)===0n&&(g0[i]&~r&~Y(n))!==0n)return!0;const g=oe(n,e,i),E=se(i);let d=~0n;if(r&f){const m=ne(n,e,i),a=z0(m);if(a>1)return m0(n,e,i,r,t)!==0n;if(a!==1)throw console.log(J0(n,e,t,o)),console.log(Y0(r)),pn(n),console.log(Y0(Ln(c))),new Error("KING IN CHECK W/O CHECKERS");const B=ln(m);I[B]%6===en?d=m:d=ee(i,B)|m}const u=q0(e);for(const m of u){const a=I[m],B=re(n,a,m,e,o,t,r,g,E);if((On(a)?B:B&d)!==0n)return!0}return!1},fn=n=>{const e=n.piece;let t=null;if((e===G||e===J)&&Math.abs(n.to-n.from)===16){const o=e===G?-8:8;t=n.to+o}return t};function Z(n,e,t,o){let s=0n,c=n;for(;c=(c&t)<<e,!(!c||c===0n);){if(c&o){s|=c;break}s|=c}return s}const Vt=(n,e,t,o=!1,s=null)=>{let c="";const r=t%8,l=o0[r],i=(t-r)/8,f=I[t],g=gt[f],E=f>5?_:Q;if(g==="P"||s){if(o){const d=e%8;c+=o0[d]+"x"}c+=l+(i+1)}else g==="K"&&Math.abs(e-t)===2?e-t===2?c="O-O-O":c="O-O":(c+=g,o&&(c+="x"),c+=l+(i+1));if(s&&(c+="="+g),Nn(n,E)){if(dn(n,E,null,null).length===0)return c+="#",c;c+="+"}return c};function Gt(n,e){let t=1n<<BigInt(e),o=0n;return o|=Z(t,9n,Hn&Vn,n),o|=Z(t,7n,Qn&Vn,n),o|=Z(t,-7n,Hn&Gn,n),o|=Z(t,-9n,Qn&Gn,n),o}function ie(n,e){let t=1n<<BigInt(e),o=0n;return o|=Z(t,1n,Hn,n),o|=Z(t,-1n,Qn,n),o|=Z(t,8n,Vn,n),o|=Z(t,-8n,Gn,n),o}const le=Array.from({length:64},(n,e)=>$t(e)),fe=Array.from({length:64},(n,e)=>jt(e));function ue(n,e){return e*8+n}function $t(n){const e=n%8,t=Math.floor(n/8);let o=0n;const s=[[0,1],[0,-1],[1,0],[-1,0]];for(const[c,r]of s){let l=e+c,i=t+r;for(;l>=0&&l<8&&i>=0&&i<8;){const f=l+c,g=i+r;if(f>=8||f<0||g>=8||g<0)break;o|=1n<<BigInt(ue(l,i)),l+=c,i+=r}}return o}function jt(n){const e=n%8,t=Math.floor(n/8);let o=0n;const s=[[1,1],[-1,1],[1,-1],[-1,-1]];for(const[c,r]of s){let l=e+c,i=t+r;for(;l>0&&l<7&&i>0&&i<7;)o|=1n<<BigInt(ue(l,i)),l+=c,i+=r}return o}const d0=[58,59,59,59,59,59,59,58,59,59,59,59,59,59,59,59,59,59,57,57,57,57,59,59,59,59,57,55,55,57,59,59,59,59,57,55,55,57,59,59,59,59,57,57,57,57,59,59,59,59,59,59,59,59,59,59,58,59,59,59,59,59,59,58],ae=[0x1084200882008102n,0x818102100410000n,0x4064440182010000n,0x8108048110040402n,0x3604102800000108n,0x105042024040010n,0x4140c04260010n,0x8000208a080b4000n,0x40420288120084n,0x200900123040080n,0x8020140104030440n,0x260040400802108n,0x1c2040422000104n,0xa2020510081000n,0x1200084100a1002n,0x20008a20822008n,0x400c001120080102n,0x1020043032008100n,0x2a1002802002201n,0xc001008801490000n,0x2401008811400000n,0x2100800040602002n,0x302000043042002n,0x40820202012111n,0x1402180040084804n,0x228021044240800n,0x208088081040100n,0x528822008020020n,0x111200a0020080c0n,0x2808020480404600n,0x88010044440a00n,0x2002044002840380n,0x402108090020a000n,0x408011008040c41n,0x2021205010800n,0x404018a0120200n,0x40054010030101n,0x4008902100208084n,0x1008408100040905n,0x42004108014420n,0x8250c10022000n,0x2a084104001800n,0x30400a2002414n,0x200041a44000804n,0x4122000e0800c00n,0x1002201045008080n,0x30016801108080n,0x8402040400208080n,0x2801828808410000n,0x81010190040021n,0x300120203044000n,0x406020484240004n,0x4500001006020042n,0x400142428820010n,0x2440050800810004n,0x1842040c003000n,0x8420210090410n,0x200008841082000n,0x4c01000046080401n,0x11008000810c8801n,0x18003400a0042400n,0x20019020114100n,0x100402903010204n,0x4040190401020020n],E0=[52,53,53,53,53,53,52,52,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,53,54,54,54,54,54,54,53,52,53,53,53,53,53,53,52],ge=[0x8080008414400221n,0x504000100c200041n,0x1100200010484101n,0x2300200900100004n,0x1000a3500100800n,0x8200030810060004n,0xa00241800a20001n,0x2200009200410024n,0x2820800070844000n,0x38400320005000n,0x200260012c280n,0x2016801000480084n,0x4001000c11010801n,0xa0008c2001004n,0x14000110421804n,0x2025800049000080n,0x440008000482388n,0x801008c004422001n,0x9420008010002480n,0x802a0042002010n,0x401010004880230n,0xc02808004010600n,0xd40042019008n,0x8044220001008044n,0x804080010020c308n,0x8040600280400085n,0xd800200100104102n,0x4007002100100108n,0x1015050100080030n,0x1008540080420080n,0x4000110400221098n,0x818004600008304n,0x440002046800282n,0x100834000802001n,0x1060200501003040n,0x429809000800800n,0x240080c401800800n,0x4002011092000428n,0x400c031004002802n,0x114092000104n,0x8200c00480288004n,0x2810024220064000n,0x39002000110041n,0x3410100100090020n,0x400480091010014n,0x1402001008420064n,0x90a02a0001008080n,0x100400c0820005n,0x8041088040620200n,0x620020d1008200n,0xe60009000208080n,0x80b0018008001080n,0x340808801040080n,0x4409000884000300n,0x18201001c8020400n,0x0000800041000080n,0x2000110040660082n,0x4000210040098011n,0x82000104100a00dn,0x1002084500029n,0x201000c50020801n,0x82001004012822n,0x8008084090210204n,0x102044810406n],k0=Array(64),p0=Array(64);function*me(n){for(let e=n;yield e,e!==0n;e=e-1n&n);}for(let n=0;n<64;n++){const e=le[n],t=fe[n],o=1<<64-E0[n],s=1<<64-d0[n];k0[n]=new Array(o),p0[n]=new Array(s);for(const c of me(e)){const r=c&e,i=BigInt.asUintN(64,r*BigInt(ge[n]))>>BigInt(E0[n]),f=Number(i),g=ie(c,n);k0[n][f]=g}for(const c of me(t)){const r=Number(BigInt.asUintN(64,(c&t)*BigInt(ae[n]))>>BigInt(d0[n])),l=Gt(c,n);p0[n][r]=l}}function En(n,e){const t=e&fe[n],o=Number(BigInt.asUintN(64,t*ae[n])>>BigInt(d0[n]));return p0[n][o]}function kn(n,e){const t=e&le[n],o=Number(BigInt.asUintN(64,t*ge[n])>>BigInt(E0[n]));return k0[n][o]}function zt(n,e,t){switch(e){case G:return jn[t];case J:return zn[t];case en:case hn:return a0[t];case F:case W:return g0[t];case sn:case rn:return En(t,n);case N:case L:return kn(t,n);case z:case D:return En(t,n)|kn(t,n);default:return 0n}}function An(n,e){let t=0n;const o=H[n];for(const s of o)t|=zt(e,n,s);return t}function pn(n){const e=Y(n);for(let t=0;t<b;t++)nn[t]=An(t,e);return nn}const nn=new BigUint64Array(b).fill(0n);pn(U);const Dn=(n,e)=>{const t=e.piece,o=e.captured,s=e.promotion,c=Y(n);j0(t)||(nn[t]=An(t,c)),o!==null&&!j0(o)&&(nn[o]=An(o,c)),(s===en||s===hn)&&(nn[s]=An(s,c));const r=[sn,N,z,rn,L,D],l=Xt(e);for(const i of r)Dt(i,e,c,l)};function Dt(n,e,t,o){if(e.captured===n||e.piece===n||e.promotion===n){nn[n]=An(n,t);return}(nn[n]&o)!==0n&&(nn[n]=An(n,t))}function Xt(n){let e=0n;if(e|=1n<<BigInt(n.from),e|=1n<<BigInt(n.to),n.enPassant){const t=n.piece<6?-8:8,o=n.to+t;e|=1n<<BigInt(o)}return e}const Ln=n=>{let e=0n;if(n===_)for(let t=0;t<6;t++)e|=nn[t];else for(let t=6;t<=11;t++)e|=nn[t];return e},Bn=(n,e,t)=>{const o=[...t];return n===4?(o[s0]=!1,o[r0]=!1):n===60?(o[c0]=!1,o[i0]=!1):n===0||e===0?o[r0]=!1:n===7||e===7?o[s0]=!1:n===56||e===56?o[i0]=!1:(n===63||e===63)&&(o[c0]=!1),o},de=(n,e,t)=>{let o;n===_?o=[4,5,6]:o=[60,61,62];for(const s of o){const c=1n<<BigInt(s);if(e&c||c&t&&(n===_?s!==4:s!==60))return!1}return!0},Ee=(n,e,t)=>{let o;n===_?o=[1,2,3,4]:o=[57,58,59,60];for(const s of o){const c=1n<<BigInt(s);if(e&c&&s!==1&&s!==57||c&t&&(n===_?s!==4:s!==60))return!1}return!0},qt=(n,e)=>{const t=e.from,o=e.to;Y(n),t===4&&o===6?(n[F]&=~(1n<<4n),n[F]|=1n<<6n,n[N]&=~(1n<<7n),n[N]|=1n<<5n,I[o]=F,I[t]=null,I[7]=null,I[5]=N):t===4&&o===2?(n[F]&=~(1n<<4n),n[F]|=1n<<2n,n[N]&=~(1n<<0n),n[N]|=1n<<3n,I[o]=F,I[t]=null,I[0]=null,I[3]=N):t===60&&o===62?(n[W]&=~(1n<<60n),n[W]|=1n<<62n,n[L]&=~(1n<<63n),n[L]|=1n<<61n,I[o]=W,I[t]=null,I[63]=null,I[61]=L):t===60&&o===58&&(n[W]&=~(1n<<60n),n[W]|=1n<<58n,n[L]&=~(1n<<56n),n[L]|=1n<<59n,I[o]=W,I[t]=null,I[56]=null,I[59]=L),D0(e),Dn(n,e)},Yt=(n,e)=>{const t=e.from,o=e.to;Y(n),t===4&&o===6?(n[F]&=~(1n<<6n),n[F]|=1n<<4n,n[N]&=~(1n<<5n),n[N]|=1n<<7n,I[t]=F,I[o]=null,I[5]=null,I[7]=N):t===4&&o===2?(n[F]&=~(1n<<2n),n[F]|=1n<<4n,n[N]&=~(1n<<3n),n[N]|=1n<<0n,I[t]=F,I[o]=null,I[3]=null,I[0]=N):t===60&&o===62?(n[W]&=~(1n<<62n),n[W]|=1n<<60n,n[L]&=~(1n<<61n),n[L]|=1n<<63n,I[t]=W,I[o]=null,I[61]=null,I[63]=L):t===60&&o===58&&(n[W]&=~(1n<<58n),n[W]|=1n<<60n,n[L]&=~(1n<<59n),n[L]|=1n<<56n,I[t]=W,I[o]=null,I[59]=null,I[56]=L),X0(e),Dn(n,e)},B0=Object.freeze({HISTORY:"history",BATTLE:"battle",NEW:"new",NONE:null}),X=Object.freeze({BMV1:"BMV1",BMV2:"BMV2",BMV3:"BMV3",BMV4:"BMV4",BMV5:"BMV5"});X.BMV1,X.BMV2,X.BMV3,X.BMV4,X.BMV5;const ke=()=>({bitboards:U.slice(),pastBitboards:[],pastMoves:[],pastPositions:new Map,currPlayer:_,boardViewSide:_,enPassantSquare:null,castlingRights:[!0,!0,!0,!0],fiftyMoveRuleCounter:0,promotion:!1,promotionMove:null,isGameOver:!1,result:null,gameHistory:[],userSide:_,selectedEngine:X.BMV5,engineDepth:4,engineTimeLimitMs:5e3,displayedBitboards:U.slice(),selectedSquare:null,moveBitboard:null,isCurrPositionShown:!0,currIndexOfDisplayed:-1,isModalOpen:!1,modalType:B0.NONE,breakBattleLoop:!1}),un=ut((n,e)=>{u0(U),pn(U),f0(U);const t=ke();return n(t),{...t,updateStates:(o,s,c)=>{n(r=>{let l=r.fiftyMoveRuleCounter+1;const i=s.piece;return(s.captured!==null||i===G||i===J)&&(l=0),{isGameOver:c.isGameOver,result:c.result,pastMoves:[...r.pastMoves,o],enPassantSquare:fn(s),castlingRights:Bn(s.from,s.to,r.castlingRights),selectedSquare:null,moveBitboard:null,pastPositions:r.pastPositions,pastBitboards:[...r.pastBitboards,r.bitboards.slice()],displayedBitboards:r.bitboards.slice(),currIndexOfDisplayed:r.currIndexOfDisplayed+1,currPlayer:r.currPlayer===_?Q:_,fiftyMoveRuleCounter:l,promotion:!1,promotionMove:null}})},resetGame:({isEngineGame:o=!1,userSide:s=null,engine:c=X.BMV5,engine2:r=null,depth:l=4,timeLimitMs:i=5e3})=>{const f=e(),g=f.isGameOver?{moves:f.pastMoves,bitboards:f.pastBitboards,result:f.result,isEngineGame:o,userSide:f.userSide}:null;if(!Object.values(X).includes(c)){console.warn("Invalid engine passed");return}const E=g?[...f.gameHistory,g]:f.gameHistory;u0(U),pn(U),f0(U),n(()=>({...ke(),gameHistory:E,userSide:s,selectedEngine:c,engineDepth:l,engineTimeLimitMs:i,boardViewSide:s}))},updateShownGame:o=>{const s=o.bitboards[o.bitboards.length-1];n(()=>({pastMoves:o.moves,pastBitboards:o.bitboards,bitboards:s,result:o.result,displayedBitboards:s,isCurrPositionShown:!1,currIndexOfDisplayed:o.bitboards.length-1}))},goToMove:(o,s)=>{n(c=>{let r=o*2+s;const l=r===c.pastBitboards.length-1;return{displayedBitboards:l?c.bitboards.slice():c.pastBitboards[r],isCurrPositionShown:l,currIndexOfDisplayed:r}})},openModal(o){if(!Object.values(B0).includes(o)){console.warn(`Invalid modal type: ${o}`);return}n(()=>({isModalOpen:!0,modalType:o}))},closeModal:()=>{n(()=>({isModalOpen:!1,modalType:B0.NONE}))},flipBoardView:()=>{n(o=>({boardViewSide:o.boardViewSide===_?Q:_}))},changeViewedMove:o=>{const s=e(),c=s.currIndexOfDisplayed+o;c<0||c>=s.pastBitboards.length||(n(r=>({displayedBitboards:r.pastBitboards[c],currIndexOfDisplayed:r.currIndexOfDisplayed+o})),c===s.pastBitboards.length-1?n(()=>({isCurrPositionShown:!0})):n(()=>({isCurrPositionShown:!1,selectedSquare:null,moveBitboard:null})))},addHistoryEntry:o=>{n(s=>({gameHistory:[...s.gameHistory,o]}))}}}),Mn=(n,e,t,o,s)=>{const c=e===_,r=c?Q:_,l=Ln(e),i={isGameOver:!1,result:null};if(Jt(n))return i.isGameOver=!0,i.result="Draw by Insufficient Material",i;if(bt(s))return i.isGameOver=!0,i.result="Draw By 50 Move Rule",i;if(Zt(t))return i.isGameOver=!0,i.result="Draw by Repetition",i;if(!Qt(n,r,null,o)){i.isGameOver=!0;const g=H[c?W:F][0];if(ce(g,l)){const E=c?"White":"Black";return i.result=`${E} Wins by Checkmate`,i}return i.result="Draw by Stalemate",i}return i},Jt=n=>{const e=Pn(n),t=Tn(n),o=n[z]|n[D],s=n[N]|n[L],c=n[G]|n[J];return(o|s|c)!==0n?!1:$0(e)<=2&&$0(t)<=2},Zt=n=>{for(let e of n.values())if(e>=3)return!0;return!1},bt=n=>n>=100;function In(){const n=Math.floor(Math.random()*4294967296),e=Math.floor(Math.random()*4294967296);return BigInt(n)<<32n|BigInt(e)}const tn=new BigUint64Array(b*64);for(let n=0;n<b;n++)for(let e=0;e<64;e++)tn[n*64+e]=In();const M0=Array(8).fill(null).map(()=>In()),no=[In(),In(),In(),In()],pe=In(),Un=(n,e,t=null,o=null)=>{let s=0n;const c=Rn();for(const r of c){const l=I[r];s^=tn[l*64+r]}if(e===Q&&(s^=pe),t>=0&&(s^=M0[t]),o)for(let r=0;r<o.length;r++)o[r]&&(s^=no[r]);return s},yn=(n,e,t,o,s)=>{let c=n;const r=e.from,l=e.to,i=e.captured,f=tn[e.piece*64+r];c^=f;const g=e.promotion?e.promotion:e.piece,E=tn[g*64+l];if(c^=E,i!==null){const d=tn[i*64+l];c^=d}if(c^=pe,t!==o&&(t>=0&&(c^=M0[t]),o>=0&&(c^=M0[o])),e.castling){const d=r===4,u=d?N:L;if(r>l){const m=d?0:56;c^=tn[u*64+m];const a=m+3;c^=tn[u*64+a]}else{const m=d?7:63;c^=tn[u*64+m];const a=m-2;c^=tn[u*64+a]}}for(let d=0;d<s.length;d++)s[d]&&(c^=dt[d]);return c};class Be{constructor(e){this.cache=new Map,this.maxSize=e}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){const o=this.cache.keys().next().value;this.cache.delete(o)}this.cache.set(e,t)}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}getSize(){return this.cache.size}}const Me=1<<20,I0=new Be(Me),P={EXACT:0,LOWER_BOUND:1,UPPER_BOUND:2},Xn=()=>{I0.clear()},_0=n=>I0.get(n),h0=(n,e)=>{I0.set(n,e)},x0=new Be(Me),Ie=()=>{x0.clear()},_e=n=>x0.get(n),he=(n,e)=>{x0.set(n,e)},xe=(n,e,t)=>{if(e)return e.includes("Checkmate")?-cn+t:0;let o=0;const s=Rn();for(const c of s){const r=I[c];o+=xn[r]}return n===_?o:-o},we=(n,e,t,o,s,c,r,l,i,f)=>{const g=e===_?Q:_,E=Mn(n,g,s,o,0);if(E.isGameOver)return{score:xe(g,E.result,r),move:null};if(r>=l&&(!Nn(n,e)||r!==l))return{score:xe(e,E.result,r),move:null};const d=dn(n,e,t,o).map(B=>{let S=0;return B.captured&&(S+=(xn[B.captured%6]||0)-(xn[B.piece%6]||0)),{move:B,score:S}});if(d.length===0)throw new Error("Issue with move generation. No moves generated");d.sort((B,S)=>S.score-B.score);const u=d.map(B=>B.move);let m=-1/0,a=null;for(const B of u){mn(n,B);const S=B.from,R=fn(B),p=Bn(S,B.to,t),A=new Map(s),C=R?R%8:-1,M=o?o%8:-1,k=new Array(p.length);for(let O=0;O<p.length;O++)t[O]!==p[O]?k[O]=!0:k[O]=!1;const h=yn(c,B,C,M,k);A.set(h,(A.get(h)||0)+1);const{score:y}=we(n,g,p,R,A,h,r+1,l,-f,-i);wn(B,n);const x=-y;if(x>m&&(m=y,a=B),x>i&&(i=x),f<=i)break}return{score:m,move:a}};function eo(n,e,t,o,s,c,r=1/0){Xn();const l=performance.now();let i=null,f=null;const g=o?o%8:-1,E=Un(n,e,g,t);for(let d=1;d<=c;d++){pn(n);const{score:u,move:m}=we(n,e,t,o,s,E,0,d,-1/0,1/0);if(m!=null&&(i=m,f=u),Math.abs(u)>cn-d&&m)break;if(performance.now()-l>r){console.log("time limit");break}}return{...i,bestEval:f}}const Ae=(n,e,t)=>{if(e)return e.includes("Checkmate")?-cn+t:0;let o=0;const s=Rn();for(const c of s){const r=I[c];o+=xn[r]}return n===_?o:-o},ye=Array.from({length:l0},()=>[null,null]),ve=Array.from({length:64},()=>Array(64).fill(0)),Se=(n,e,t,o,s,c,r,l,i,f)=>{const g=e===_?Q:_,E=Mn(n,g,s,o,0);if(E.isGameOver)return{score:Ae(g,E.result,r),move:null};if(r>=l&&(!Nn(n,e)||r!==l))return{score:Ae(e,E.result,r),move:null};const d=c,u=i,m=l-r,a=_0(d);if(a&&a.depth>=m&&a.rootId===qn){if(a.flag===P.EXACT)return{score:a.value,move:a.bestMove};if(a.flag===P.LOWER_BOUND&&(i=Math.max(i,a.value)),a.flag===P.UPPER_BOUND&&(f=Math.min(f,a.value)),i>=f)return{score:a.value,move:a.bestMove}}const B=(a==null?void 0:a.bestMove)||null,S=dn(n,e,t,o).map(M=>{let k=0;const h=M.from,y=M.to;B&&h===B.from&&y===B.to&&(k+=1e6),M.captured&&(k+=1e5+(xn[M.captured%6]||0)-(xn[M.piece%6]||0));const[x,O]=ye[r];return x&&h===x.from&&y===x.to?k+=9e4:O&&h===O.from&&y===O.to&&(k+=8e4),k+=ve[h][y],{move:M,score:k}});if(S.length===0)throw new Error("Issue with move generation. No moves generated");S.sort((M,k)=>k.score-M.score);const R=S.map(M=>M.move);let p=-1/0,A=null;for(const M of R){mn(n,M);const k=M.from,h=fn(M),y=Bn(k,M.to,t),x=new Map(s),O=h?h%8:-1,$=o?o%8:-1,V=new Array(y.length);for(let K=0;K<y.length;K++)t[K]!==y[K]?V[K]=!0:V[K]=!1;const w=yn(c,M,O,$,V);x.set(w,(x.get(w)||0)+1);const{score:on}=Se(n,g,y,h,x,w,r+1,l,-f,-i);wn(M,n);const an=-on;if(an>p&&(p=an,A=M),an>i&&(i=an),f<=i){if(M.captured===null){const K=ye[r];(!K[0]||M.from!==K[0].from||M.to!==K[0].to)&&(K[1]=K[0],K[0]=M),ve[M.from][M.to]+=2^l-r}break}}let C=P.EXACT;return p<=u?C=P.UPPER_BOUND:p>=f&&(C=P.LOWER_BOUND),h0(d,{rootId:qn,depth:l-r,value:p,flag:C,bestMove:A}),{score:p,move:A}};let qn=0;function to(n,e,t,o,s,c,r=1/0){Xn();const l=performance.now();let i=null,f=null;const g=o?o%8:-1,E=Un(n,e,g,t);qn=0;for(let d=1;d<=c;d++){pn(n);const{score:u,move:m}=Se(n,e,t,o,s,E,0,d,-1/0,1/0);if(m!=null&&(f=u,i=m),Math.abs(u)>cn-d&&m)break;if(performance.now()-l>r){console.log("time limit");break}qn++}return{...i,bestEval:f}}const w0=(n,e,t)=>{if(e)return e.includes("Checkmate")?-cn+t:0;let o=0;const s=Rn();for(const c of s){const r=I[c],l=r<6?1:-1;o+=l*vn[r%6]}return n===_?o:-o},vn=[100,320,330,500,900,2e4],Ce=(n,e,t)=>dn(n,e,null,t).filter(s=>s.captured!==null||s.promotion),A0=6,Oe=Array.from({length:A0},()=>[null,null]),Pe=Array.from({length:64},()=>Array(64).fill(0)),Te=(n,e,t,o,s,c,r,l,i=0)=>{const f=e===_?Q:_,g=Mn(n,f,r,s,0);if(g.isGameOver)return{score:w0(f,g.result,0),move:null};const E=w0(e,null,0);if(i+1>A0)return{score:E,move:null};if(E>=o)return{score:o,move:null};const d=t;t=Math.max(t,E);const u=_e(l),m=A0-i;if(u&&u.depth>=m&&u.isQuiescence){if(u.flag===P.EXACT)return{score:u.value,move:null};if(u.flag===P.LOWER_BOUND&&u.value>t?t=u.value:u.flag===P.UPPER_BOUND&&u.value<o&&(o=u.value),t>=o)return{score:u.value,move:null}}const a=(u==null?void 0:u.bestMove)||null,B=Ce(n,e,s).map(p=>{let A=0;const C=p.from,M=p.to;a&&C===a.from&&M===a.to&&(A+=1e6),p.captured&&(A+=1e5+(vn[p.captured%6]||0)-(vn[p.piece%6]||0));const[k,h]=Oe[i];return k&&C===k.from&&M===k.to?A+=9e4:h&&C===h.from&&M===h.to&&(A+=8e4),A+=Pe[C][M],{move:p,score:A}});B.sort((p,A)=>A.score-p.score);const S=B.map(p=>p.move);for(const p of S){const A=vn[p.captured%6]||0;if(E+A<=t)continue;mn(n,p);const C=fn(p),M=Bn(p.from,p.to,c),k=C?C%8:-1,h=s?s%8:-1,y=new Array(M.length);for(let w=0;w<M.length;w++)c[w]!==M[w]?y[w]=!0:y[w]=!1;const x=yn(l,p,k,h,y),O=r.get(x)||0;r.set(x,O+1);const{score:$}=Te(n,f,-o,-t,C,M,r,x,i+1);wn(p,n),O?r.set(x,O):r.delete(x);const V=-$;if(V>=o)return{score:o,move:null};if(V>t&&(t=V),o<=t){if(p.captured===null){const w=Oe[i];(!w[0]||p.from!==w[0].from||p.to!==w[0].to)&&(w[1]=w[0],w[0]=p),Pe[p.from][p.to]+=2^m}break}}let R=P.EXACT;return t<=d?R=P.UPPER_BOUND:t>=o&&(R=P.LOWER_BOUND),he(l,{value:t,depth:m,flag:R,isQuiescence:!0}),{score:t,move:null}},Re=Array.from({length:l0},()=>[null,null]),Ne=Array.from({length:64},()=>Array(64).fill(0)),Le=(n,e,t,o,s,c,r,l,i,f)=>{const g=e===_?Q:_,E=Mn(n,g,s,o,0);if(E.isGameOver)return{score:w0(g,E.result,r),move:null};if(r>=l&&(!Nn(n,e)||r!==l))return{score:Te(n,e,i,f,o,t,s,c).score,move:null};const d=c,u=i,m=l-r,a=_0(d);if(a&&a.depth>=m&&a.rootId===Yn){if(a.flag===P.EXACT)return{score:a.value,move:a.bestMove};if(a.flag===P.LOWER_BOUND&&(i=Math.max(i,a.value)),a.flag===P.UPPER_BOUND&&(f=Math.min(f,a.value)),i>=f)return{score:a.value,move:a.bestMove}}const B=(a==null?void 0:a.bestMove)||null,S=dn(n,e,t,o).map(k=>{let h=0;const y=k.from,x=k.to;B&&y===B.from&&x===B.to&&(h+=1e6),k.captured&&(h+=1e5+(vn[k.captured%6]||0)-(vn[k.piece%6]||0));const[O,$]=Re[r];return O&&y===O.from&&x===O.to?h+=9e4:$&&y===$.from&&x===$.to&&(h+=8e4),h+=Ne[y][x],{move:k,score:h}});if(S.length===0)throw new Error("Issue with move generation. No moves generated");S.sort((k,h)=>h.score-k.score);const R=S.map(k=>k.move);let p=-1/0,A=null;for(const k of R){mn(n,k);const h=k.from,y=fn(k),x=Bn(h,k.to,t),O=y?y%8:-1,$=o?o%8:-1,V=new Array(x.length);for(let T=0;T<x.length;T++)t[T]!==x[T]?V[T]=!0:V[T]=!1;const w=yn(c,k,O,$,V),on=s.get(w)||0;s.set(w,on+1);const{score:an}=Le(n,g,x,y,s,w,r+1,l,-f,-i);wn(k,n),on?s.set(w,on):s.delete(w);const K=-an;if(K>p&&(p=K,A=k),K>i&&(i=K),f<=i){if(k.captured===null){const T=Re[r];(!T[0]||k.from!==T[0].from||k.to!==T[0].to)&&(T[1]=T[0],T[0]=k),Ne[k.from][k.to]+=2^l-r}break}}let C=P.EXACT;const M=p;return M<=u?C=P.UPPER_BOUND:M>=f&&(C=P.LOWER_BOUND),h0(d,{rootId:Yn,depth:l-r,value:M,flag:C,bestMove:A}),{score:p,move:A}};let Yn=0;function oo(n,e,t,o,s,c,r=1/0){Xn(),Ie();const l=performance.now();let i=null,f=null;const g=o?o%8:-1,E=Un(n,e,g,t);Yn=0;for(let d=1;d<=c;d++){pn(n);const{score:u,move:m}=Le(n,e,t,o,s,E,0,d,-1/0,1/0);if(m!==null&&(f=u,i=m),Math.abs(u)>cn-d&&m||performance.now()-l>r)break;Yn++}return{...i,bestEval:f}}const so=[[0,0,0,0,0,0,0,0,5,10,10,-20,-20,10,10,5,5,-5,-10,0,0,-10,-5,5,0,0,10,20,20,0,0,0,5,5,10,25,25,10,5,5,10,10,20,30,30,20,10,10,50,50,50,50,50,50,50,50,0,0,0,0,0,0,0,0],[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,5,5,0,-20,-40,-30,5,20,15,15,20,5,-30,-30,0,15,25,25,15,0,-30,-30,5,15,25,25,15,5,-30,-30,0,10,15,15,10,0,-30,-40,-20,0,0,0,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],[-20,-10,-10,-10,-10,-10,-10,-20,-10,5,0,0,0,0,5,-10,-10,10,10,10,10,10,10,-10,-10,0,10,10,10,10,0,-10,-10,5,5,10,10,5,5,-10,-10,0,5,10,10,5,0,-10,-10,0,0,0,0,0,0,-10,-20,-10,-10,-10,-10,-10,-10,-20],[0,0,5,10,10,5,0,0,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,5,10,10,10,10,10,10,5,0,0,0,0,0,0,0,0],[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,5,0,-10,-10,0,5,5,5,5,5,-10,-5,0,5,5,5,5,0,0,-5,0,5,5,5,5,0,-5,-10,0,5,5,5,5,0,-10,-10,0,0,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],[20,30,10,0,0,10,30,20,20,20,0,0,0,0,20,20,-10,-20,-20,-20,-20,-20,-20,-10,-20,-30,-30,-40,-40,-30,-30,-20,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30],[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,10,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0],[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,25,25,15,5,-30,-30,0,15,25,25,15,0,-30,-30,5,20,15,15,20,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],[-20,-10,-10,-10,-10,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,10,10,5,0,-10,-10,5,5,10,10,5,5,-10,-10,0,10,10,10,10,0,-10,-10,10,10,10,10,10,10,-10,-10,5,0,0,0,0,5,-10,-20,-10,-10,-10,-10,-10,-10,-20],[0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,0,0,0,5,5,0,0,0],[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,0,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20]],y0=(n,e,t)=>{if(e)return e.includes("Checkmate")?-cn+t:0;let o=0;const s=Rn();for(const c of s){const r=I[c],l=r<6?1:-1;o+=l*(Sn[r%6]+so[r][c])}return n===_?o:-o},Sn=[100,320,330,500,900,2e4],v0=10,Ue=Array.from({length:v0},()=>[null,null]),Ke=Array.from({length:64},()=>Array(64).fill(0)),Fe=(n,e,t,o,s,c,r,l,i=0)=>{const f=e===_?Q:_,g=Mn(n,f,r,s,0);if(g.isGameOver)return{score:y0(f,g.result,0),move:null};const E=y0(e,null,0);if(i+1>v0)return{score:E,move:null};if(E>=o)return{score:o,move:null};const d=t;t=Math.max(t,E);const u=_e(l),m=v0-i;if(u&&u.depth>=m&&u.isQuiescence){if(u.flag===P.EXACT)return{score:u.value,move:null};if(u.flag===P.LOWER_BOUND&&u.value>t?t=u.value:u.flag===P.UPPER_BOUND&&u.value<o&&(o=u.value),t>=o)return{score:u.value,move:null}}const a=(u==null?void 0:u.bestMove)||null,B=Ce(n,e,s).map(p=>{let A=0;const C=p.from,M=p.to;a&&C===a.from&&M===a.to&&(A+=1e6),p.captured&&(A+=1e5+(Sn[p.captured%6]||0)-(Sn[p.piece%6]||0));const[k,h]=Ue[i];return k&&C===k.from&&M===k.to?A+=9e4:h&&C===h.from&&M===h.to&&(A+=8e4),A+=Ke[C][M],{move:p,score:A}});B.sort((p,A)=>A.score-p.score);const S=B.map(p=>p.move);for(const p of S){const A=Sn[p.captured%6]||0;if(E+A<=t)continue;mn(n,p);const C=fn(p),M=Bn(p.from,p.to,c),k=C?C%8:-1,h=s?s%8:-1,y=new Array(M.length);for(let w=0;w<M.length;w++)c[w]!==M[w]?y[w]=!0:y[w]=!1;const x=yn(l,p,k,h,y),O=r.get(x)||0;r.set(x,O+1);const{score:$}=Fe(n,f,-o,-t,C,M,r,x,i+1);wn(p,n),O?r.set(x,O):r.delete(x);const V=-$;if(V>=o)return{score:o,move:null};if(V>t&&(t=V),o<=t){if(p.captured===null){const w=Ue[i];(!w[0]||p.from!==w[0].from||p.to!==w[0].to)&&(w[1]=w[0],w[0]=p),Ke[p.from][p.to]+=2^m}break}}let R=P.EXACT;return t<=d?R=P.UPPER_BOUND:t>=o&&(R=P.LOWER_BOUND),he(l,{value:t,depth:m,flag:R,isQuiescence:!0}),{score:t,move:null}},We=Array.from({length:l0},()=>[null,null]),He=Array.from({length:64},()=>Array(64).fill(0)),Qe=(n,e,t,o,s,c,r,l,i,f)=>{const g=e===_?Q:_,E=Mn(n,g,s,o,0);if(E.isGameOver)return{score:y0(g,E.result,r),move:null};if(r>=l&&(!Nn(n,e)||r!==l))return{score:Fe(n,e,i,f,o,t,s,c).score,move:null};const d=c,u=i,m=l-r,a=_0(d);if(a&&a.depth>=m&&a.rootId===Jn){if(a.flag===P.EXACT)return{score:a.value,move:a.bestMove};if(a.flag===P.LOWER_BOUND&&(i=Math.max(i,a.value)),a.flag===P.UPPER_BOUND&&(f=Math.min(f,a.value)),i>=f)return{score:a.value,move:a.bestMove}}const B=(a==null?void 0:a.bestMove)||null,S=dn(n,e,t,o).map(k=>{let h=0;const y=k.from,x=k.to;B&&y===B.from&&x===B.to&&(h+=1e6),k.captured&&(h+=1e5+(Sn[k.captured%6]||0)-(Sn[k.piece%6]||0));const[O,$]=We[r];return O&&y===O.from&&x===O.to?h+=9e4:$&&y===$.from&&x===$.to&&(h+=8e4),h+=He[y][x],{move:k,score:h}});if(S.length===0)throw new Error("Issue with move generation. No moves generated");S.sort((k,h)=>h.score-k.score);const R=S.map(k=>k.move);let p=-1/0,A=null;for(const k of R){mn(n,k);const h=k.from,y=fn(k),x=Bn(h,k.to,t),O=y?y%8:-1,$=o?o%8:-1,V=new Array(x.length);for(let T=0;T<x.length;T++)t[T]!==x[T]?V[T]=!0:V[T]=!1;const w=yn(c,k,O,$,V),on=s.get(w)||0;s.set(w,on+1);const{score:an}=Qe(n,g,x,y,s,w,r+1,l,-f,-i);wn(k,n),on?s.set(w,on):s.delete(w);const K=-an;if(K>p&&(p=K,A=k),K>i&&(i=K),f<=i){if(k.captured===null){const T=We[r];(!T[0]||k.from!==T[0].from||k.to!==T[0].to)&&(T[1]=T[0],T[0]=k),He[k.from][k.to]+=2^l-r}break}}let C=P.EXACT;const M=p;return M<=u?C=P.UPPER_BOUND:M>=f&&(C=P.LOWER_BOUND),h0(d,{rootId:Jn,depth:l-r,value:M,flag:C,bestMove:A}),{score:p,move:A}};let Jn=0;function ro(n,e,t,o,s,c,r=1/0){Xn(),Ie();const l=performance.now();let i=null,f=null;const g=o?o%8:-1,E=Un(n,e,g,t);Jn=0;for(let d=1;d<=c;d++){const{score:u,move:m}=Qe(n,e,t,o,s,E,0,d,-1/0,1/0);if(m!==null&&(f=u,i=m),Math.abs(u)>cn-d&&m||performance.now()-l>r)break;Jn++}return{...i,bestEval:f}}const co=(n,e,t,o,s=new Map,c=0,r=1/0)=>{const l=dn(n,e,t,o);return l[Math.floor(Math.random()*l.length)]},io={[X.BMV1]:co,[X.BMV2]:eo,[X.BMV3]:to,[X.BMV4]:oo,[X.BMV5]:ro},lo=async()=>{const n=await At();for(const e of n){const t=Z0(e.slice(0,2)),o=Z0(e.slice(2,4));Ge(t,o,null)}},Ve=(n,e=3,t=1/0)=>{const{isCurrPositionShown:o,isGameOver:s,bitboards:c,currPlayer:r,castlingRights:l,enPassantSquare:i,pastPositions:f}=un.getState();if(!o||s)return;const g=io[n],E=g(c,r,l,i,f,e,t),d=E.from,u=E.to,m=E.promotion;Ge(d,u,m)},Ge=(n,e,t=null)=>{const{bitboards:o,currPlayer:s,castlingRights:c,enPassantSquare:r,pastPositions:l,updateStates:i,fiftyMoveRuleCounter:f}=un.getState(),g=I[n],E=On(g)&&Math.abs(n-e)===2,d=e===r&&(g===G||g===J);let u=I[e];d&&(u=g===G?J:G);const m=new $n(n,e,g,u,t,E,d);mn(o,m);const a=fn(m),B=a?a%8:-1,S=Un(o,s,B,c);l.set(S,(l.get(S)||0)+1);const R=Mn(o,s,l,a,f),p=Vt(o,n,e,m.captured!==null);i(p,m,R)};self.onmessage=async n=>{const{engine1:e,eng1Depth:t,engine2:o,eng2Depth:s,games:c}=n.data;un.setState({userSide:null});const{breakBattleLoop:r,resetGame:l}=un.getState();let i=0,f=0,g=0,E=1,d=e,u=o,m=t,a=s;for(;E<=c&&!r;){for(l({isEngineGame:!0}),await lo();!un.getState().isGameOver&&(Ve(d,m,5e3),!un.getState().isGameOver);)Ve(u,a,5e3);const S=un.getState().result,R=E%2===1?1:2,p=S.charAt(0);p===(R===1?"W":"B")?i++:p==="D"?f++:g++,l({isEngineGame:!0}),[d,u]=[u,d],[m,a]=[a,m];const C=un.getState().gameHistory,M=C[C.length-1],k=(i/E*100).toFixed(1);self.postMessage({type:"progress",gameNum:E,wins:i,draws:f,losses:g,winRate:k,gameHistoryEntry:M}),E++}const B=(i/c*100).toFixed(1);self.postMessage({type:"done",gameNum:E,wins:i,draws:f,losses:g,winRate:B})}})();
